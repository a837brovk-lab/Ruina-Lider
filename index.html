<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruina Leader: Iron Will</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto+Condensed:wght@400;700&display=swap');

        :root {
            --hoi-bg: #1a1b1e;
            --hoi-panel: #24272b;
            --hoi-border: #4a4d52;
            --hoi-gold: #e2c08d;
            --hoi-text: #cccccc;
            --hoi-green: #4da358;
            --hoi-red: #c94f4f;
        }

        body {
            background-color: #050505;
            color: var(--hoi-text);
            font-family: 'Roboto Condensed', sans-serif;
            overflow: hidden;
            user-select: none;
        }

        /* --- –≠–§–§–ï–ö–¢–´ --- */
        .scanline {
            width: 100%; height: 100px; z-index: 999; pointer-events: none; position: absolute;
            background: linear-gradient(0deg, transparent, rgba(226, 192, 141, 0.05), transparent);
            animation: scan 10s linear infinite; top: -100px;
        }
        @keyframes scan { to { top: 100%; } }

        .crt-overlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 998;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.4) 100%);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }

        /* --- UI –ö–û–ú–ü–û–ù–ï–ù–¢–´ --- */
        .hoi-panel {
            background: url('https://www.transparenttextures.com/patterns/dark-matter.png'), var(--hoi-panel);
            border: 2px solid #000;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8), 0 0 10px rgba(0,0,0,0.5);
            outline: 1px solid var(--hoi-border);
        }

        .hoi-header {
            font-family: 'Playfair Display', serif;
            color: var(--hoi-gold);
            text-shadow: 2px 2px 0px #000;
            letter-spacing: 1px;
        }

        .hoi-btn {
            background: linear-gradient(to bottom, #4a5157, #2d3238);
            border: 1px solid #000;
            color: #fff;
            text-shadow: 1px 1px 0 #000;
            padding: 8px 16px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 4px 0 #1a1a1a;
            transition: all 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .hoi-btn:hover:not(:disabled) { filter: brightness(1.2); transform: translateY(-1px); }
        .hoi-btn:active:not(:disabled) { transform: translateY(2px); box-shadow: 0 1px 0 #1a1a1a; }
        .hoi-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .hoi-btn-green { background: linear-gradient(to bottom, #4da358, #2e6b36); }
        .hoi-btn-red { background: linear-gradient(to bottom, #c94f4f, #8a2a2a); }

        .resource-box {
            display: flex; align-items: center; gap: 6px;
            background: rgba(0,0,0,0.3); padding: 4px 10px;
            border: 1px solid var(--hoi-border); border-radius: 4px;
        }

        /* --- –ö–ê–†–¢–ê --- */
        .province { stroke: #000; stroke-width: 0.3; transition: fill 0.5s ease; }
        .province:hover { stroke: #fff; stroke-width: 1; cursor: pointer; filter: brightness(1.2); }
        .province.selected { stroke: var(--hoi-gold); stroke-width: 2; }
        
        .war-active {
            stroke: #ff0000;
            stroke-width: 1.5;
            animation: warPulse 2s infinite;
        }
        
        @keyframes warPulse {
            0% { stroke-opacity: 1; }
            50% { stroke-opacity: 0.3; }
            100% { stroke-opacity: 1; }
        }

        /* –ò–¥–µ–æ–ª–æ–≥–∏–∏ */
        .ideo-fascism { color: #a37256; }
        .ideo-communism { color: #c94f4f; }
        .ideo-democracy { color: #6db0ff; }
        .ideo-neutrality { color: #9e9e9e; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div class="scanline"></div>
    <div class="crt-overlay"></div>

    <!-- –ú–ï–ù–Æ –í–´–ë–û–†–ê –°–¢–†–ê–ù–´ -->
    <div id="setup-screen" class="fixed inset-0 z-[1000] bg-[#0d0e10] flex items-center justify-center p-8 bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')]">
        <div class="w-full max-w-7xl h-[90vh] hoi-panel flex overflow-hidden shadow-2xl relative">
            
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°–ø–∏—Å–æ–∫ -->
            <div class="w-1/4 border-r border-gray-700 flex flex-col bg-[#16181b]">
                <div class="p-4 border-b border-gray-700 bg-[#202328]">
                    <h1 class="hoi-header text-3xl mb-1">RUINA LEADER</h1>
                    <p class="text-[10px] uppercase text-gray-500 font-bold tracking-widest">Global Iron Strategy</p>
                </div>
                <div class="p-2 bg-black/20">
                    <input type="text" id="country-search" placeholder="–ü–æ–∏—Å–∫ –¥–µ—Ä–∂–∞–≤—ã..." class="w-full bg-[#0a0a0a] border border-gray-600 p-2 text-xs text-gray-300 outline-none focus:border-yellow-600">
                </div>
                <div id="country-list" class="flex-grow overflow-y-auto custom-scroll p-2 space-y-1">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –î–µ—Ç–∞–ª–∏ -->
            <div class="flex-grow flex flex-col relative bg-[#121316]">
                <!-- –ó–∞–≥–ª—É—à–∫–∞ -->
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 pointer-events-none">
                    <svg class="w-32 h-32 mb-4 opacity-20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                    <span class="uppercase tracking-widest font-bold opacity-50">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –Ω–∞—á–∞–ª–∞</span>
                </div>

                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
                <div id="preview-content" class="hidden h-full flex flex-col p-10">
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <h2 id="p-name" class="text-6xl font-black text-white uppercase tracking-tighter shadow-black drop-shadow-lg">–†–û–°–°–ò–Ø</h2>
                            <div class="flex items-center gap-3 mt-2">
                                <span id="p-ideology" class="px-2 py-0.5 bg-black/50 border border-gray-600 text-xs font-bold uppercase text-gray-300">–ê–≤—Ç–æ—Ä–∏—Ç–∞—Ä–∏–∑–º</span>
                                <span class="text-xs text-gray-500">–°–¶–ï–ù–ê–†–ò–ô: 2000 –ì–û–î</span>
                            </div>
                        </div>
                        <img id="p-flag" class="w-40 h-24 border-4 border-[#24272b] shadow-2xl">
                    </div>

                    <div class="flex gap-10 flex-grow">
                        <div class="w-64 h-80 bg-black border-4 border-[#e2c08d] relative shadow-2xl group">
                            <img id="p-leader-img" class="w-full h-full object-cover filter grayscale sepia-[0.2] group-hover:filter-none transition duration-500">
                            <div class="absolute bottom-0 w-full bg-black/80 p-2 text-center border-t border-[#e2c08d]">
                                <span id="p-leader-name" class="text-[#e2c08d] font-bold text-sm uppercase font-serif tracking-wider"></span>
                            </div>
                        </div>

                        <div class="flex-grow flex flex-col gap-6">
                            <div class="bg-[#1a1b1e] border border-gray-700 p-6 shadow-inner">
                                <h3 class="text-xs text-gray-500 font-bold uppercase mb-4 tracking-widest border-b border-gray-700 pb-2">–†–∞–∑–≤–µ–¥–¥–∞–Ω–Ω—ã–µ</h3>
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <span class="block text-[10px] text-gray-500 uppercase">–í–í–ü</span>
                                        <span id="p-gdp" class="text-2xl font-bold text-[#4da358]">$260B</span>
                                    </div>
                                    <div>
                                        <span class="block text-[10px] text-gray-500 uppercase">–ê—Ä–º–∏—è</span>
                                        <span id="p-army" class="text-2xl font-bold text-[#c94f4f]">1.2M</span>
                                    </div>
                                    <div>
                                        <span class="block text-[10px] text-gray-500 uppercase">–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å</span>
                                        <span id="p-stab" class="text-xl font-bold text-[#e2c08d]">65%</span>
                                    </div>
                                    <div>
                                        <span class="block text-[10px] text-gray-500 uppercase">–ü–æ–ø—É–ª—è—Ü–∏—è</span>
                                        <span id="p-pop" class="text-xl font-bold text-gray-300">146M</span>
                                    </div>
                                </div>
                            </div>
                            
                            <p id="p-desc" class="text-sm text-gray-400 italic leading-relaxed border-l-2 border-[#e2c08d] pl-4"></p>
                            
                            <div class="mt-auto">
                                <button onclick="startGame()" class="hoi-btn hoi-btn-green w-full py-4 text-xl tracking-widest shadow-lg hover:scale-[1.01] transition-transform">
                                    <span class="text-2xl">‚ö°</span> –ü–†–ò–ù–Ø–¢–¨ –£–ü–†–ê–í–õ–ï–ù–ò–ï
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù -->
    <div id="game-ui" class="hidden h-screen flex flex-col bg-[#0b0c0e]">
        
        <!-- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ -->
        <header class="h-12 bg-gradient-to-b from-[#2d3238] to-[#1a1b1e] border-b border-black flex items-center justify-between px-4 z-50 shadow-lg">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-2" title="–í–∞—à–∞ —Å—Ç—Ä–∞–Ω–∞">
                    <img id="ui-flag" class="w-8 h-5 border border-white/20">
                    <span id="ui-country" class="font-bold text-sm text-[#e2c08d] uppercase tracking-tighter"></span>
                </div>
                
                <!-- –†–µ—Å—É—Ä—Å—ã -->
                <div class="flex gap-4 text-xs font-mono">
                    <div class="resource-box" title="–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –≤–ª–∞—Å—Ç—å">
                        <span>üèõÔ∏è</span> <span id="res-pp" class="font-bold text-white">150</span>
                    </div>
                    <div class="resource-box" title="–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å">
                        <span>‚öñÔ∏è</span> <span id="res-stab" class="font-bold text-[#e2c08d]">70%</span>
                    </div>
                    <div class="resource-box" title="–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–æ–π–Ω—ã">
                        <span>‚öîÔ∏è</span> <span id="res-war" class="font-bold text-[#c94f4f]">10%</span>
                    </div>
                    <div class="resource-box" title="–õ—é–¥—Å–∫–∏–µ —Ä–µ—Å—É—Ä—Å—ã">
                        <span>üë•</span> <span id="res-man" class="font-bold text-[#4da358]">1.2M</span>
                    </div>
                    <div class="resource-box" title="–§–∞–±—Ä–∏–∫–∏">
                        <span>üè≠</span> <span id="res-fac" class="font-bold text-gray-300">45</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="text-xs font-bold bg-black/30 px-3 py-1 rounded text-gray-400 font-mono">
                    <span id="ui-date">1 –Ø–ù–í 2000</span>
                </div>
                <button class="hoi-btn py-1 px-3 text-xs" onclick="toggleMenu()">–ú–ï–ù–Æ</button>
            </div>
        </header>

        <!-- –û–°–ù–û–í–ù–ê–Ø –ó–û–ù–ê -->
        <main class="flex-grow flex relative overflow-hidden">
            <!-- –ö–∞—Ä—Ç–∞ -->
            <div id="map-container" class="flex-grow bg-[#14181d] relative">
                <svg id="world-map" class="w-full h-full cursor-crosshair"></svg>
                
                <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –î–ò–ü–õ–û–ú–ê–¢–ò–ò (–°–∫—Ä—ã—Ç–∞) -->
                <div id="diplomacy-panel" class="absolute left-4 top-4 w-96 hoi-panel hidden flex-col z-40 max-h-[90vh] overflow-y-auto animate-slide-in">
                    <div class="p-2 bg-gradient-to-r from-[#2d3238] to-[#1a1b1e] border-b border-black flex justify-between items-center">
                        <span class="font-bold text-[#e2c08d] uppercase tracking-wider ml-2">–î–∏–ø–ª–æ–º–∞—Ç–∏—è</span>
                        <button onclick="closeDiplo()" class="text-gray-500 hover:text-white px-2 font-bold">‚úï</button>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        <!-- –®–∞–ø–∫–∞ —Ü–µ–ª–∏ -->
                        <div class="flex gap-4">
                            <div class="w-20 h-28 bg-black border-2 border-[#e2c08d]">
                                <img id="diplo-leader-img" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-col flex justify-center">
                                <h3 id="diplo-country" class="text-xl font-black uppercase leading-none">–ì–ï–†–ú–ê–ù–ò–Ø</h3>
                                <p id="diplo-leader" class="text-xs text-yellow-600 font-bold mb-2">–ì. –®—Ä—ë–¥–µ—Ä</p>
                                <div class="flex gap-2 text-[10px]">
                                    <span id="diplo-ideology" class="px-2 py-0.5 bg-white/5 border border-white/10 rounded">–î–µ–º–æ–∫—Ä–∞—Ç–∏—è</span>
                                    <span id="diplo-opinion" class="px-2 py-0.5 bg-green-900/30 text-green-400 border border-green-800 rounded">+10</span>
                                </div>
                            </div>
                        </div>

                        <!-- –°—Ç–∞—Ç—É—Å –≤–æ–π–Ω—ã -->
                        <div id="war-status-bar" class="hidden mb-2">
                            <div class="text-[10px] text-red-500 font-bold mb-1 flex justify-between">
                                <span>–ü–†–û–ì–†–ï–°–° –û–ö–ö–£–ü–ê–¶–ò–ò</span>
                                <span id="war-progress-text">0%</span>
                            </div>
                            <div class="w-full h-2 bg-black border border-red-900">
                                <div id="war-progress-bar" class="h-full bg-red-600 w-0"></div>
                            </div>
                        </div>

                        <!-- –î–∞–Ω–Ω—ã–µ -->
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="bg-black/30 p-2 border border-white/5 flex justify-between">
                                <span class="text-gray-500">–ê—Ä–º–∏—è</span>
                                <span id="diplo-army" class="font-bold text-red-400">300K</span>
                            </div>
                            <div class="bg-black/30 p-2 border border-white/5 flex justify-between">
                                <span class="text-gray-500">–ò–Ω–¥—É—Å—Ç—Ä–∏—è</span>
                                <span id="diplo-ind" class="font-bold text-yellow-400">120</span>
                            </div>
                        </div>

                        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                        <div class="space-y-2 pt-2 border-t border-gray-700">
                            <button onclick="diploAction('war_goal')" class="hoi-btn w-full justify-start border-red-900/50 text-red-300 hover:text-red-100">
                                <span>‚öîÔ∏è</span> –û–ø—Ä–∞–≤–¥–∞—Ç—å —Ü–µ–ª—å –≤–æ–π–Ω—ã
                            </button>
                            <button onclick="diploAction('improve')" class="hoi-btn w-full justify-start">
                                <span>ü§ù</span> –£–ª—É—á—à–∏—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è
                            </button>
                            <button onclick="diploAction('alliance')" class="hoi-btn w-full justify-start">
                                <span>üõ°Ô∏è</span> –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤ –∞–ª—å—è–Ω—Å
                            </button>
                            <button onclick="diploAction('lend_lease')" class="hoi-btn w-full justify-start">
                                <span>üì¶</span> –ù–∞—á–∞—Ç—å –õ–µ–Ω–¥-–ª–∏–∑
                            </button>
                            <button onclick="diploAction('trade')" class="hoi-btn w-full justify-start">
                                <span>üí∞</span> –¢–æ—Ä–≥–æ–≤–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π -->
        <div id="event-log" class="absolute bottom-2 left-2 w-80 max-h-40 overflow-y-auto pointer-events-none space-y-1 text-[10px] font-mono p-2 bg-black/50 border border-white/10 rounded"></div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –í–û–ô–ù–´ (CASUS BELLI) -->
    <div id="war-modal" class="modal-overlay hidden">
        <div class="hoi-panel w-[600px] p-1 shadow-[0_0_50px_rgba(201,79,79,0.2)] border-red-900">
            <div class="bg-[#1a0505] p-6 border border-red-900/30">
                <h2 class="hoi-header text-3xl text-red-500 text-center mb-2">–û–ë–™–Ø–í–õ–ï–ù–ò–ï –í–û–ô–ù–´</h2>
                <p class="text-center text-gray-400 text-xs mb-6 uppercase tracking-widest">–ú–∏—Ä–æ–≤–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ —Ç—Ä–µ–±—É–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–π</p>
                
                <div class="mb-4">
                    <label class="text-xs font-bold text-[#e2c08d] block mb-2">CASUS BELLI (–ü–û–í–û–î –ö –í–û–ô–ù–ï)</label>
                    <textarea id="war-reason" rows="4" class="w-full bg-black border border-gray-700 p-3 text-sm text-gray-300 focus:border-red-500 outline-none" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É (–Ω–∞–ø—Ä. '–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –∑–µ–º–µ–ª—å' –∏–ª–∏ '–ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω—ã–π —É–¥–∞—Ä')..."></textarea>
                </div>

                <div id="ai-analysis" class="hidden mb-4 p-3 bg-black/40 border-l-2 border-yellow-600 text-xs italic text-gray-400">
                    <span class="text-yellow-600 font-bold not-italic">–ì–ï–ù–®–¢–ê–ë –ê–ù–ê–õ–ò–ó–ò–†–£–ï–¢:</span> <span id="ai-text">...</span>
                </div>

                <div class="flex gap-4 justify-center">
                    <button onclick="closeModal('war-modal')" class="hoi-btn w-32">–û–¢–ú–ï–ù–ê</button>
                    <button id="btn-confirm-war" onclick="confirmWar()" class="hoi-btn hoi-btn-red w-48 shadow-red-900/50">–û–¢–ü–†–ê–í–ò–¢–¨ –£–õ–¨–¢–ò–ú–ê–¢–£–ú</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –õ–ï–ù–î-–õ–ò–ó–ê -->
    <div id="lend-lease-modal" class="modal-overlay hidden">
        <div class="hoi-panel w-[500px] p-6">
            <h3 class="hoi-header text-2xl text-[#e2c08d] mb-4">–õ–ï–ù–î-–õ–ò–ó</h3>
            <p class="text-xs text-gray-400 mb-4">–û—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–µ–Ω–Ω–æ–≥–æ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è –∏ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–æ—é–∑–Ω–∏–∫—É.</p>
            <div class="space-y-4 mb-6">
                <div>
                    <div class="flex justify-between text-xs mb-1"><span>–ü–µ—Ö–æ—Ç–Ω–æ–µ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</span><span>1000 –µ–¥.</span></div>
                    <input type="range" class="w-full accent-[#e2c08d] h-2 bg-black rounded appearance-none cursor-pointer">
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1"><span>–¢–∞–Ω–∫–∏</span><span>50 –µ–¥.</span></div>
                    <input type="range" class="w-full accent-[#e2c08d] h-2 bg-black rounded appearance-none cursor-pointer">
                </div>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('lend-lease-modal')" class="hoi-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button onclick="sendLendLease()" class="hoi-btn hoi-btn-green">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω–≤–æ–π</button>
            </div>
        </div>
    </div>

    <script>
        // --- –ò–°–¢–û–†–ò–ß–ï–°–ö–ê–Ø –ë–ê–ó–ê –õ–ò–î–ï–†–û–í (2000-2026) ---
        const HISTORY = {
            "RUS": [
                { y: 2000, n: "–í–ª–∞–¥–∏–º–∏—Ä –ü—É—Ç–∏–Ω", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/Vladimir_Putin_-_2000-11-15.jpg/220px-Vladimir_Putin_-_2000-11-15.jpg" },
                { y: 2008, n: "–î–º–∏—Ç—Ä–∏–π –ú–µ–¥–≤–µ–¥–µ–≤", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/8d/Dmitry_Medvedev_2008.jpg/220px-Dmitry_Medvedev_2008.jpg" },
                { y: 2012, n: "–í–ª–∞–¥–∏–º–∏—Ä –ü—É—Ç–∏–Ω", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/Vladimir_Putin_2024.jpg/220px-Vladimir_Putin_2024.jpg" }
            ],
            "USA": [
                { y: 2000, n: "–ë–∏–ª–ª –ö–ª–∏–Ω—Ç–æ–Ω", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Bill_Clinton.jpg/220px-Bill_Clinton.jpg" },
                { y: 2001, n: "–î–∂–æ—Ä–¥–∂ –ë—É—à –º–ª.", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/George-W-Bush.jpg/220px-George-W-Bush.jpg" },
                { y: 2009, n: "–ë–∞—Ä–∞–∫ –û–±–∞–º–∞", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/8d/President_Barack_Obama.jpg/220px-President_Barack_Obama.jpg" },
                { y: 2017, n: "–î–æ–Ω–∞–ª—å–¥ –¢—Ä–∞–º–ø", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/56/Donald_Trump_official_portrait.jpg/220px-Donald_Trump_official_portrait.jpg" },
                { y: 2021, n: "–î–∂–æ –ë–∞–π–¥–µ–Ω", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/68/Joe_Biden_presidential_portrait.jpg/220px-Joe_Biden_presidential_portrait.jpg" },
                { y: 2025, n: "–î–æ–Ω–∞–ª—å–¥ –¢—Ä–∞–º–ø", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/56/Donald_Trump_official_portrait.jpg/220px-Donald_Trump_official_portrait.jpg" }
            ],
            "UKR": [
                { y: 2000, n: "–õ–µ–æ–Ω–∏–¥ –ö—É—á–º–∞", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/00/Leonid_Kuchma_2003.jpg/220px-Leonid_Kuchma_2003.jpg" },
                { y: 2005, n: "–í–∏–∫—Ç–æ—Ä –Æ—â–µ–Ω–∫–æ", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/Viktor_Yushchenko_2005.jpg/220px-Viktor_Yushchenko_2005.jpg" },
                { y: 2010, n: "–í–∏–∫—Ç–æ—Ä –Ø–Ω—É–∫–æ–≤–∏—á", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e9/Viktor_Yanukovych_2010.jpg/220px-Viktor_Yanukovych_2010.jpg" },
                { y: 2014, n: "–ü–µ—Ç—Ä –ü–æ—Ä–æ—à–µ–Ω–∫–æ", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/Petro_Poroshenko_official_portrait.jpg/220px-Petro_Poroshenko_official_portrait.jpg" },
                { y: 2019, n: "–í–ª–∞–¥–∏–º–∏—Ä –ó–µ–ª–µ–Ω—Å–∫–∏–π", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Volodymyr_Zelensky_Official_Portrait.jpg/220px-Volodymyr_Zelensky_Official_Portrait.jpg" }
            ],
            "DEU": [
                { y: 2000, n: "–ì–µ—Ä—Ö–∞—Ä–¥ –®—Ä—ë–¥–µ—Ä", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4b/Gerhard_Schroeder_2005.jpg/220px-Gerhard_Schroeder_2005.jpg" },
                { y: 2005, n: "–ê–Ω–≥–µ–ª–∞ –ú–µ—Ä–∫–µ–ª—å", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b6/Angela_Merkel_2010.jpg/220px-Angela_Merkel_2010.jpg" },
                { y: 2021, n: "–û–ª–∞—Ñ –®–æ–ª—å—Ü", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d1/Olaf_Scholz_2022.jpg/220px-Olaf_Scholz_2022.jpg" }
            ]
        };

        // --- –ë–ê–ó–ê –î–ê–ù–ù–´–• 30 –°–¢–†–ê–ù ---
        const COUNTRIES = [
            { id: "RUS", name: "–†–æ—Å—Å–∏—è", flag: "ru", gdp: 260, army: 1200, stab: 65, color: "#4a6b4a", ideology: "NEUTRALITY", desc: "–°—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–ª–∏—è–Ω–∏–µ." },
            { id: "USA", name: "–°–®–ê", flag: "us", gdp: 10200, army: 1400, stab: 90, color: "#1a3a6a", ideology: "DEMOCRACY", desc: "–ú–∏—Ä–æ–≤–æ–π –≥–µ–≥–µ–º–æ–Ω." },
            { id: "CHN", name: "–ö–∏—Ç–∞–π", flag: "cn", gdp: 1200, army: 2200, stab: 88, color: "#8a2a2a", ideology: "COMMUNISM", desc: "–°–ø—è—â–∏–π –¥—Ä–∞–∫–æ–Ω." },
            { id: "DEU", name: "–ì–µ—Ä–º–∞–Ω–∏—è", flag: "de", gdp: 1950, army: 300, stab: 85, color: "#333", ideology: "DEMOCRACY", desc: "–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ —Å–µ—Ä–¥—Ü–µ –ï–≤—Ä–æ–ø—ã." },
            { id: "GBR", name: "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è", flag: "gb", gdp: 1600, army: 210, stab: 80, color: "#384a8c", ideology: "DEMOCRACY", desc: "–í–µ—Ä–Ω—ã–π —Å–æ—é–∑–Ω–∏–∫ –°–®–ê." },
            { id: "FRA", name: "–§—Ä–∞–Ω—Ü–∏—è", flag: "fr", gdp: 1500, army: 250, stab: 75, color: "#385e8c", ideology: "DEMOCRACY", desc: "–õ–∏–¥–µ—Ä –ï–°." },
            { id: "UKR", name: "–£–∫—Ä–∞–∏–Ω–∞", flag: "ua", gdp: 32, army: 300, stab: 55, color: "#3d6e8a", ideology: "NEUTRALITY", desc: "–ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –í–æ—Å—Ç–æ–∫–æ–º –∏ –ó–∞–ø–∞–¥–æ–º." },
            { id: "JPN", name: "–Ø–ø–æ–Ω–∏—è", flag: "jp", gdp: 4800, army: 240, stab: 95, color: "#8c8c8c", ideology: "DEMOCRACY", desc: "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –≥–∏–≥–∞–Ω—Ç." },
            { id: "IND", name: "–ò–Ω–¥–∏—è", flag: "in", gdp: 460, army: 1300, stab: 60, color: "#a65c1a", ideology: "DEMOCRACY", desc: "–†–∞—Å—Ç—É—â–∞—è –¥–µ—Ä–∂–∞–≤–∞." },
            { id: "ITA", name: "–ò—Ç–∞–ª–∏—è", flag: "it", gdp: 1100, army: 190, stab: 65, color: "#3a7a4a", ideology: "DEMOCRACY", desc: "–ö—É–ª—å—Ç—É—Ä–Ω—ã–π —Ü–µ–Ω—Ç—Ä." },
            { id: "TUR", name: "–¢—É—Ä—Ü–∏—è", flag: "tr", gdp: 270, army: 500, stab: 55, color: "#7a2a2a", ideology: "NEUTRALITY", desc: "–°—Ç—Ä–∞–∂ –ø—Ä–æ–ª–∏–≤–æ–≤." },
            { id: "IRN", name: "–ò—Ä–∞–Ω", flag: "ir", gdp: 100, army: 550, stab: 50, color: "#3a5a4a", ideology: "FASCISM", desc: "–ò—Å–ª–∞–º—Å–∫–∞—è —Ä–µ—Å–ø—É–±–ª–∏–∫–∞." },
            { id: "IRQ", name: "–ò—Ä–∞–∫", flag: "iq", gdp: 40, army: 400, stab: 45, color: "#5a5a3a", ideology: "FASCISM", desc: "–†–µ–∂–∏–º –ø–æ–¥ —Å–∞–Ω–∫—Ü–∏—è–º–∏." },
            { id: "SAU", name: "–°–∞—É–¥. –ê—Ä–∞–≤–∏—è", flag: "sa", gdp: 190, army: 200, stab: 80, color: "#2a5a2a", ideology: "FASCISM", desc: "–ù–µ—Ñ—Ç—è–Ω–∞—è –º–æ–Ω–∞—Ä—Ö–∏—è." },
            { id: "ISR", name: "–ò–∑—Ä–∞–∏–ª—å", flag: "il", gdp: 130, army: 170, stab: 70, color: "#2a3a6a", ideology: "DEMOCRACY", desc: "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–π —Ñ–æ—Ä–ø–æ—Å—Ç." },
            { id: "BRA", name: "–ë—Ä–∞–∑–∏–ª–∏—è", flag: "br", gdp: 650, army: 300, stab: 60, color: "#2a6a3a", ideology: "DEMOCRACY", desc: "–õ–∏–¥–µ—Ä –Æ–∂–Ω–æ–π –ê–º–µ—Ä–∏–∫–∏." },
            { id: "KAZ", name: "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω", flag: "kz", gdp: 20, army: 60, stab: 80, color: "#2a6a6a", ideology: "NEUTRALITY", desc: "–ë–æ–≥–∞—Ç—ã–µ —Ä–µ—Å—É—Ä—Å—ã." },
            { id: "BLR", name: "–ë–µ–ª–∞—Ä—É—Å—å", flag: "by", gdp: 12, army: 50, stab: 85, color: "#3a6a3a", ideology: "FASCISM", desc: "–í–µ—Ä–Ω—ã–π —Å–æ—é–∑–Ω–∏–∫ –†–æ—Å—Å–∏–∏." },
            { id: "PRK", name: "–ö–ù–î–†", flag: "kp", gdp: 10, army: 1100, stab: 95, color: "#7a1a1a", ideology: "COMMUNISM", desc: "–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ." },
            { id: "KOR", name: "–Æ–∂. –ö–æ—Ä–µ—è", flag: "kr", gdp: 560, army: 600, stab: 80, color: "#1a2a5a", ideology: "DEMOCRACY", desc: "–ê–∑–∏–∞—Ç—Å–∫–∏–π —Ç–∏–≥—Ä." },
            { id: "CAN", name: "–ö–∞–Ω–∞–¥–∞", flag: "ca", gdp: 740, army: 60, stab: 90, color: "#8a2a2a", ideology: "DEMOCRACY", desc: "–ú–∏—Ä–Ω—ã–π —Å–æ—Å–µ–¥ –°–®–ê." },
            { id: "AUS", name: "–ê–≤—Å—Ç—Ä–∞–ª–∏—è", flag: "au", gdp: 415, army: 55, stab: 90, color: "#1a2a6a", ideology: "DEMOCRACY", desc: "–°—Ç—Ä–∞–∂ –¢–∏—Ö–æ–≥–æ –æ–∫–µ–∞–Ω–∞." },
            { id: "POL", name: "–ü–æ–ª—å—à–∞", flag: "pl", gdp: 170, army: 120, stab: 75, color: "#8a4a4a", ideology: "DEMOCRACY", desc: "–í–æ—Å—Ç–æ—á–Ω—ã–π —Ñ–ª–∞–Ω–≥." },
            { id: "ESP", name: "–ò—Å–ø–∞–Ω–∏—è", flag: "es", gdp: 600, army: 130, stab: 70, color: "#8a7a2a", ideology: "DEMOCRACY", desc: "–†–∞–∑–≤–∏–≤–∞—é—â–∞—è—Å—è —ç–∫–æ–Ω–æ–º–∏–∫–∞." },
            { id: "SWE", name: "–®–≤–µ—Ü–∏—è", flag: "se", gdp: 260, army: 30, stab: 95, color: "#2a4a7a", ideology: "DEMOCRACY", desc: "–°–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏–π –Ω–µ–π—Ç—Ä–∞–ª–∏—Ç–µ—Ç." },
            { id: "IDN", name: "–ò–Ω–¥–æ–Ω–µ–∑–∏—è", flag: "id", gdp: 165, army: 300, stab: 45, color: "#8a3a3a", ideology: "DEMOCRACY", desc: "–ö—Ä—É–ø–Ω–µ–π—à–∞—è –º—É—Å—É–ª—å–º–∞–Ω—Å–∫–∞—è –¥–µ–º–æ–∫—Ä–∞—Ç–∏—è." },
            { id: "PAK", name: "–ü–∞–∫–∏—Å—Ç–∞–Ω", flag: "pk", gdp: 75, army: 600, stab: 40, color: "#2a5a3a", ideology: "FASCISM", desc: "–Ø–¥–µ—Ä–Ω–∞—è –¥–µ—Ä–∂–∞–≤–∞." },
            { id: "VNM", name: "–í—å–µ—Ç–Ω–∞–º", flag: "vn", gdp: 33, army: 480, stab: 80, color: "#8a1a1a", ideology: "COMMUNISM", desc: "–ê–∑–∏–∞—Ç—Å–∫–∏–π —Ç–∏–≥—Ä –Ω–∞ —Å—Ç–∞—Ä—Ç–µ." },
            { id: "ARG", name: "–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞", flag: "ar", gdp: 285, army: 70, stab: 40, color: "#3a7a9a", ideology: "DEMOCRACY", desc: "–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏." },
            { id: "EGY", name: "–ï–≥–∏–ø–µ—Ç", flag: "eg", gdp: 100, army: 450, stab: 60, color: "#6a5a3a", ideology: "NEUTRALITY", desc: "–õ–∏–¥–µ—Ä –∞—Ä–∞–±—Å–∫–æ–≥–æ –º–∏—Ä–∞." }
        ];

        let gameState = {
            player: null,
            target: null,
            date: new Date(2000, 0, 1),
            activeWars: {} // { targetId: progress (0-100) }
        };

        let timer = null;

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        window.onload = async () => {
            await initMap();
            renderList();
        };

        async function initMap() {
            const svg = d3.select("#world-map");
            const width = window.innerWidth;
            const height = window.innerHeight;

            try {
                const res = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2.0.2/countries-110m.json');
                const data = await res.json();
                const features = topojson.feature(data, data.objects.countries).features;

                const projection = d3.geoMercator().scale(width / 6.5).translate([width/2.2, height/1.8]);
                const path = d3.geoPath().projection(projection);

                svg.append("g")
                    .selectAll("path")
                    .data(features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .attr("class", "province")
                    .attr("id", d => {
                        // –ú–∞–ø–ø–∏–Ω–≥ GeoJSON -> ID
                        const found = COUNTRIES.find(c => c.name === d.properties.name || mapName(d.properties.name) === c.id);
                        return found ? found.id : "UNK_" + d.id;
                    })
                    .attr("fill", d => {
                        const found = COUNTRIES.find(c => c.name === d.properties.name || mapName(d.properties.name) === c.id);
                        return found ? found.color : "#1a1e24";
                    })
                    .on("click", function(e, d) {
                        const id = this.getAttribute("id");
                        if (!id.startsWith("UNK")) {
                            if (!gameState.player) selectCountry(COUNTRIES.find(c => c.id === id));
                            else openDiplomacy(COUNTRIES.find(c => c.id === id));
                        }
                    });

            } catch (e) { console.error("Map Error", e); }
        }

        function mapName(name) {
            const map = { "Russia": "RUS", "United States of America": "USA", "China": "CHN", "Germany": "DEU", "Ukraine": "UKR", "France": "FRA", "United Kingdom": "GBR", "Japan": "JPN", "India": "IND", "Brazil": "BRA", "Italy": "ITA", "Turkey": "TUR", "Kazakhstan": "KAZ", "Belarus": "BLR", "Canada": "CAN", "Australia": "AUS", "Spain": "ESP", "Poland": "POL", "Sweden": "SWE", "Norway": "NOR", "Finland": "FIN", "Iran": "IRN", "Iraq": "IRQ", "Saudi Arabia": "SAU", "Israel": "ISR", "South Korea": "KOR", "North Korea": "PRK", "Egypt": "EGY", "Pakistan": "PAK", "Vietnam": "VNM", "Indonesia": "IDN", "Argentina": "ARG" };
            return map[name];
        }

        // --- –ú–ï–ù–Æ ---
        function renderList() {
            const list = document.getElementById('country-list');
            COUNTRIES.forEach(c => {
                const el = document.createElement('div');
                el.className = "p-2 bg-white/5 border border-white/5 hover:bg-yellow-600/20 cursor-pointer flex items-center justify-between";
                el.innerHTML = `
                    <div class="flex items-center gap-2">
                        <img src="https://flagcdn.com/w40/${c.flag}.png" class="w-6 h-4 border border-black">
                        <span class="text-xs font-bold text-gray-300">${c.name}</span>
                    </div>
                    <span class="text-[8px] uppercase text-gray-500">${c.ideology}</span>
                `;
                el.onclick = () => selectCountry(c);
                list.appendChild(el);
            });
        }

        function selectCountry(c) {
            gameState.player = c;
            const leader = getLeader(c.id, 2000);
            
            document.getElementById('p-name').innerText = c.name;
            document.getElementById('p-ideology').innerText = c.ideology;
            document.getElementById('p-flag').src = `https://flagcdn.com/w160/${c.flag}.png`;
            document.getElementById('p-leader-name').innerText = leader.n;
            document.getElementById('p-leader-img').src = leader.i;
            document.getElementById('p-desc').innerText = c.desc;
            document.getElementById('p-gdp').innerText = `$${c.gdp}B`;
            document.getElementById('p-army').innerText = `${c.army}K`;
            
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('preview-content').classList.remove('hidden');
        }

        function startGame() {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            
            const p = gameState.player;
            const leader = getLeader(p.id, 2000);
            
            document.getElementById('ui-flag').src = `https://flagcdn.com/w40/${p.flag}.png`;
            document.getElementById('ui-country').innerText = p.name;
            document.getElementById('ui-leader-name').innerText = leader.n;
            
            document.getElementById('res-pp').innerText = 150;
            document.getElementById('res-money').innerText = `$${p.gdp/5}B`;
            
            setInterval(gameLoop, 1000); // 1 —Å–µ–∫ = 1 –¥–µ–Ω—å
            addEvent("–í—ã –ø—Ä–∏–Ω—è–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ–º. –ú–∏—Ä –æ–∂–∏–¥–∞–µ—Ç –≤–∞—à–∏—Ö —Ä–µ—à–µ–Ω–∏–π.");
        }

        // --- –ì–ï–ô–ú–ü–õ–ï–ô ---
        function gameLoop() {
            // –î–∞—Ç–∞
            gameState.date.setDate(gameState.date.getDate() + 1);
            document.getElementById('ui-date').innerText = gameState.date.toLocaleDateString('ru-RU');
            const year = gameState.date.getFullYear();

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã –ª–∏–¥–µ—Ä–∞
            if (gameState.date.getDate() === 1 && HISTORY[gameState.player.id]) {
                const currentLeader = getLeader(gameState.player.id, year);
                if (document.getElementById('ui-leader-name').innerText !== currentLeader.n) {
                    document.getElementById('ui-leader-name').innerText = currentLeader.n;
                    addEvent(`–°–º–µ–Ω–∞ –≤–ª–∞—Å—Ç–∏! –ù–æ–≤—ã–π –ª–∏–¥–µ—Ä: ${currentLeader.n}`);
                }
            }

            // –í–æ–π–Ω–∞
            for (let tid in gameState.activeWars) {
                gameState.activeWars[tid] += Math.random() * 2; // –ü—Ä–æ–≥—Ä–µ—Å—Å
                const prog = gameState.activeWars[tid];
                
                document.getElementById('war-progress-bar').style.width = Math.min(100, prog) + "%";
                document.getElementById('war-progress-text').innerText = Math.floor(prog) + "%";

                if (prog >= 100) {
                    delete gameState.activeWars[tid];
                    document.getElementById('war-status-bar').classList.add('hidden');
                    d3.select(`#${tid}`).attr("fill", gameState.player.color).classed("war-active", false); // –û–∫–∫—É–ø–∞—Ü–∏—è
                    addEvent(`–ü–û–ë–ï–î–ê! ${COUNTRIES.find(c=>c.id===tid).name} –∫–∞–ø–∏—Ç—É–ª–∏—Ä–æ–≤–∞–ª–∞.`);
                }
            }
        }

        function getLeader(id, year) {
            if (year >= 2026) return generateAILeader(id, year);
            const hist = HISTORY[id];
            if (!hist) return { n: "–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –õ–∏–¥–µ—Ä", i: `https://api.dicebear.com/7.x/avataaars/svg?seed=${id}` };
            
            let l = hist[0];
            for (let h of hist) if (year >= h.y) l = h;
            return l;
        }

        function generateAILeader(id, year) {
            const seed = id + year;
            return {
                n: "–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç (AI Gen)",
                i: `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}`
            };
        }

        // --- –î–ò–ü–õ–û–ú–ê–¢–ò–Ø ---
        function openDiplomacy(target) {
            if (target.id === gameState.player.id) return;
            
            gameState.target = target;
            const panel = document.getElementById('diplomacy-panel');
            panel.classList.remove('hidden');
            
            const leader = getLeader(target.id, gameState.date.getFullYear());
            
            document.getElementById('diplo-leader-img').src = leader.i;
            document.getElementById('diplo-country').innerText = target.name;
            document.getElementById('diplo-leader').innerText = leader.n;
            document.getElementById('diplo-ideology').innerText = target.ideology;
            document.getElementById('diplo-army').innerText = `${target.army}K`;
            
            // –ï—Å–ª–∏ –≤–æ–π–Ω–∞ –∏–¥–µ—Ç
            if (gameState.activeWars[target.id]) {
                document.getElementById('war-status-bar').classList.remove('hidden');
            } else {
                document.getElementById('war-status-bar').classList.add('hidden');
            }
        }

        function closeDiplo() { document.getElementById('diplomacy-panel').classList.add('hidden'); }

        function diploAction(action) {
            if (action === 'war_goal') {
                showModal('war');
            } else if (action === 'alliance') {
                if (gameState.player.ideology === gameState.target.ideology) {
                    addEvent(`–ê–ª—å—è–Ω—Å —Å ${gameState.target.name} –∑–∞–∫–ª—é—á–µ–Ω!`);
                } else {
                    addEvent(`${gameState.target.name} –æ—Ç–∫–ª–æ–Ω–∏–ª–∞ –∞–ª—å—è–Ω—Å.`);
                }
            } else if (action === 'lend_lease') {
                showModal('lend');
            }
        }

        function showModal(type) {
            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById('war-modal').classList.add('hidden');
            document.getElementById('lend-lease-modal').classList.add('hidden');
            
            if (type === 'war') document.getElementById('war-modal').classList.remove('hidden');
            else document.getElementById('lend-lease-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        async function confirmWar() {
            const reason = document.getElementById('war-reason').value;
            const btn = document.getElementById('btn-confirm-war');
            const analysis = document.getElementById('ai-analysis');
            
            btn.disabled = true;
            btn.innerText = "–ê–ù–ê–õ–ò–ó –ì–ï–ù–®–¢–ê–ë–ê...";
            analysis.classList.remove('hidden');
            
            setTimeout(() => {
                let verdict = "–ü—Ä–∏—á–∏–Ω–∞ —Å–ª–∞–±–∞—è. –û—Å—É–∂–¥–µ–Ω–∏–µ –û–û–ù –Ω–µ–∏–∑–±–µ–∂–Ω–æ.";
                if (reason.length > 10) verdict = "–ö–∞–∑—É—Å –±–µ–ª–ª–∏ –ø—Ä–∏–∑–Ω–∞–Ω –ª–µ–≥–∏—Ç–∏–º–Ω—ã–º. –ù–∞—Ä–æ–¥ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–æ–±–∏–ª–∏–∑–∞—Ü–∏—é.";
                
                document.getElementById('ai-text').innerText = verdict;
                
                setTimeout(() => {
                    gameState.activeWars[gameState.target.id] = 0;
                    d3.select(`#${gameState.target.id}`).classed("war-active", true); // –í–∏–∑—É–∞–ª –≤–æ–π–Ω—ã
                    addEvent(`–í–û–ô–ù–ê –ù–ê–ß–ê–¢–ê –ü–†–û–¢–ò–í ${gameState.target.name}!`);
                    closeModal();
                    openDiplomacy(gameState.target); // –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
                }, 1500);
            }, 1000);
        }

        function sendLendLease() {
            addEvent(`–ö–æ–Ω–≤–æ–π —Å –ø–æ–º–æ—â—å—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ ${gameState.target.name}.`);
            closeModal();
        }

        function addEvent(msg) {
            const log = document.getElementById('event-log');
            const div = document.createElement('div');
            div.className = "text-gray-400 mb-1 border-l-2 border-yellow-600 pl-2";
            div.innerHTML = `<span class="text-yellow-600">[${gameState.date.toLocaleDateString()}]</span> ${msg}`;
            log.prepend(div);
        }

    </script>
</body>
</html>
