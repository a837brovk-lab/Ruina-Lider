<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Century of Crisis: Millennium Dawn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@400;700&family=Special+Elite&display=swap');

        :root {
            --bg-dark: #0a0b0a;
            --panel-bg: #1c1f1c;
            --border-color: #2f332f;
            --accent-gold: #c5a059;
            --accent-red: #8a1c1c;
            --accent-green: #3d6e38;
            --text-main: #d1d5db;
            --crt-scanline: rgba(0, 0, 0, 0.5);
        }

        body, html {
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Roboto Mono', monospace;
            overflow: hidden;
            user-select: none;
        }

        /* --- CRT EFFECT & ATMOSPHERE --- */
        .crt-overlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 9000;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%;
            opacity: 0.6;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
        }

        .scanline {
            width: 100%; height: 5px;
            background: rgba(255,255,255,0.02);
            position: absolute; top: 0; left: 0;
            animation: scan 6s linear infinite;
            pointer-events: none; z-index: 9001;
        }

        @keyframes scan { 0% {top: -5%;} 100% {top: 105%;} }

        /* --- UI COMPONENTS --- */
        .iron-panel {
            background: var(--panel-bg);
            border: 2px solid #000;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
        }
        .iron-panel::before {
            content: ''; position: absolute; inset: 0;
            border: 1px solid var(--border-color);
            pointer-events: none;
        }

        .header-font { font-family: 'Black Ops One', cursive; letter-spacing: 1px; }
        .typewriter { font-family: 'Special Elite', cursive; }

        .btn-main {
            background: linear-gradient(180deg, #3d423d 0%, #222622 100%);
            border: 1px solid #555;
            color: #ccc;
            text-transform: uppercase;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
            transition: all 0.1s;
            position: relative;
            overflow: hidden;
        }
        .btn-main:hover:not(:disabled) {
            filter: brightness(1.2); border-color: #888; color: #fff;
        }
        .btn-main:active:not(:disabled) {
            transform: translateY(2px); box-shadow: inset 0 2px 5px #000;
        }
        .btn-main:disabled {
            opacity: 0.5; cursor: not-allowed; filter: grayscale(1);
        }
        
        .btn-war { background: linear-gradient(180deg, #5c1818 0%, #360a0a 100%); border-color: #8a3636; }
        .btn-diplo { background: linear-gradient(180deg, #2b4561 0%, #152333 100%); border-color: #43668c; }
        .btn-green { background: linear-gradient(180deg, #2d5228 0%, #172b14 100%); border-color: #4a8043; }

        /* --- MAP STYLES --- */
        .province {
            stroke: rgba(0,0,0,0.3); stroke-width: 0.5;
            transition: fill 0.3s;
        }
        .province:hover {
            filter: brightness(1.2) sepia(0.2); stroke: #fff; stroke-width: 1.5; cursor: pointer;
        }
        .province.selected {
            stroke: var(--accent-gold); stroke-width: 2.5; filter: brightness(1.1);
        }
        .province.player {
            stroke: var(--accent-green); stroke-width: 2;
        }
        .province.enemy {
            fill: url(#diagonal-hatch) var(--accent-red); /* Pattern defined in SVG */
        }
        
        /* --- WAR VISUALS --- */
        @keyframes war-flash { 0% {opacity:0.6;} 50% {opacity:1;} 100% {opacity:0.6;} }
        .war-active-border {
            stroke: var(--accent-red); stroke-width: 2; stroke-dasharray: 5,3;
            animation: war-flash 1s infinite;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            display: flex; align-items: center; justify-content: center;
            z-index: 5000; backdrop-filter: blur(5px);
        }
        .modal-content {
            width: 600px; max-width: 90vw;
            background: #1a1a1a; border: 4px solid #333;
            box-shadow: 0 0 50px rgba(0,0,0,1);
            position: relative;
        }
        .modal-header {
            background: #000; color: #fff; padding: 10px 20px;
            font-family: 'Black Ops One'; font-size: 1.2rem; border-bottom: 2px solid var(--accent-gold);
        }

        /* --- PROGRESS BARS --- */
        .progress-container {
            width: 100%; height: 12px; background: #111; border: 1px solid #444; position: relative;
        }
        .progress-fill {
            height: 100%; background: repeating-linear-gradient(45deg, #b8860b, #b8860b 10px, #8b6508 10px, #8b6508 20px);
            transition: width 0.5s linear;
        }
        .war-fill {
            background: repeating-linear-gradient(45deg, #8b0000, #8b0000 10px, #5c0000 10px, #5c0000 20px);
        }

        /* --- CUSTOM SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }

        /* --- NEWS TICKER --- */
        .news-ticker-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 30px;
            background: #000; border-top: 2px solid var(--accent-gold);
            overflow: hidden; display: flex; align-items: center; z-index: 100;
        }
        .news-content {
            white-space: nowrap; padding-left: 100%;
            animation: ticker 30s linear infinite;
            font-family: 'Special Elite'; font-size: 14px; color: var(--accent-gold);
        }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

    </style>
</head>
<body>

    <div class="crt-overlay"></div>
    <div class="scanline"></div>

    <!-- SVG PATTERNS DEFINITION -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1">
        <defs>
            <pattern id="diagonal-hatch" patternUnits="userSpaceOnUse" width="8" height="8">
                <path d="M-2,2 l4,-4 M0,8 l8,-8 M6,10 l4,-4" 
                      style="stroke:#8a1c1c; stroke-width:2; opacity: 0.5" />
            </pattern>
            <pattern id="occupied-hatch" patternUnits="userSpaceOnUse" width="10" height="10">
                <rect width="10" height="10" fill="#2d5228" opacity="0.3"/>
                <path d="M-2,2 l4,-4 M0,10 l10,-10 M8,12 l4,-4" 
                      style="stroke:#4a8043; stroke-width:2; opacity: 0.5" />
            </pattern>
        </defs>
    </svg>

    <!-- LOADING / SELECTION SCREEN -->
    <div id="selection-screen" class="modal-overlay">
        <div class="modal-content" style="width: 800px; height: 600px; display: flex; flex-direction: column;">
            <div class="modal-header flex justify-between">
                <span>–í–´–ë–û–† –ù–ê–¶–ò–ò - –°–¶–ï–ù–ê–†–ò–ô 2000 –ì–û–î–ê</span>
                <span class="text-xs self-center text-gray-400">–í–ï–†–°–ò–Ø 4.2.0</span>
            </div>
            
            <div class="flex flex-grow bg-gray-900 overflow-hidden">
                <!-- Left: List -->
                <div class="w-1/3 bg-black border-r border-gray-700 flex flex-col">
                    <div class="p-2 bg-gray-800 text-xs font-bold text-center border-b border-gray-600">–î–û–°–¢–£–ü–ù–´–ï –î–ï–†–ñ–ê–í–´</div>
                    <div id="country-list" class="flex-grow overflow-y-auto p-2 space-y-1">
                        <!-- JS injected buttons -->
                    </div>
                </div>
                
                <!-- Right: Details -->
                <div class="w-2/3 p-6 flex flex-col gap-4 relative">
                    <div id="select-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500 italic opacity-50 text-center p-10">
                        –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞,<br>—á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—å–µ —Ä–∞–∑–≤–µ–¥–∫–∏.
                    </div>

                    <div id="select-details" class="hidden flex flex-col h-full">
                        <div class="flex items-center gap-4 mb-4 border-b border-gray-700 pb-4">
                            <div id="sel-flag" class="w-24 h-16 bg-gray-700 border-2 border-white shadow-lg flex items-center justify-center text-2xl font-bold text-white/20">FLAG</div>
                            <div>
                                <h2 id="sel-name" class="text-3xl font-black text-white uppercase leading-none">RUSSIA</h2>
                                <div id="sel-ideology" class="text-xs text-blue-400 font-bold mt-1">–ê–í–¢–û–†–ò–¢–ê–†–ò–ó–ú</div>
                            </div>
                        </div>

                        <div class="bg-gray-800 p-4 border border-gray-600 rounded mb-4">
                            <div class="text-[10px] text-gray-400 uppercase tracking-widest mb-2">–ì–õ–ê–í–ê –ì–û–°–£–î–ê–†–°–¢–í–ê (2000)</div>
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center overflow-hidden border-2 border-gray-500">
                                    <svg class="w-10 h-10 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                                </div>
                                <div>
                                    <div id="sel-leader" class="text-xl font-bold text-yellow-500">Vladimir Putin</div>
                                    <div class="text-xs text-gray-400 italic">"–í–ª–∞—Å—Ç—å - —ç—Ç–æ –¥–æ–ª–≥."</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-auto">
                            <div class="bg-black/40 p-2 border border-gray-700">
                                <div class="text-[9px] text-gray-500 uppercase">–í–í–ü</div>
                                <div id="sel-gdp" class="text-lg font-mono text-green-400">$2.1T</div>
                            </div>
                            <div class="bg-black/40 p-2 border border-gray-700">
                                <div class="text-[9px] text-gray-500 uppercase">–ê–†–ú–ò–Ø</div>
                                <div id="sel-army" class="text-lg font-mono text-red-400">1.2M</div>
                            </div>
                        </div>

                        <button onclick="startGame()" class="w-full py-4 btn-main text-lg tracking-widest border-2 border-yellow-600 text-yellow-500 hover:text-white">
                            –ü–†–ò–ù–Ø–¢–¨ –£–ü–†–ê–í–õ–ï–ù–ò–ï
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN GAME UI -->
    <div id="game-ui" class="hidden h-screen flex flex-col relative">
        
        <!-- TOP HEADER -->
        <header class="h-16 iron-panel flex items-center justify-between px-4 z-50">
            <!-- Left: Flag & Stats -->
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3">
                    <div id="game-flag" class="w-12 h-8 bg-gray-800 border border-white/30 shadow-md"></div>
                    <div class="leading-none">
                        <div id="game-country" class="text-lg header-font text-white">RUSSIA</div>
                        <div id="game-leader" class="text-xs text-yellow-600 font-bold uppercase typewriter">V. PUTIN</div>
                    </div>
                </div>

                <div class="h-8 w-px bg-white/10 mx-2"></div>

                <div class="flex gap-6">
                    <div title="–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –≤–ª–∞—Å—Ç—å">
                        <span class="text-[9px] block text-gray-500 uppercase">–ü. –í–ª–∞—Å—Ç—å</span>
                        <div class="flex items-center gap-1 text-white font-mono text-sm">
                            <span class="text-gray-400">üèõ</span> <span id="res-pp">250</span>
                        </div>
                    </div>
                    <div title="–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å">
                        <span class="text-[9px] block text-gray-500 uppercase">–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å</span>
                        <div class="flex items-center gap-1 text-white font-mono text-sm">
                            <span class="text-yellow-600">‚öñ</span> <span id="res-stab">80%</span>
                        </div>
                    </div>
                    <div title="–ú–∏—Ä–æ–≤–∞—è –ù–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç—å">
                        <span class="text-[9px] block text-gray-500 uppercase">–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ</span>
                        <div class="flex items-center gap-1 text-white font-mono text-sm relative group">
                            <span class="text-red-600 animate-pulse">‚ò¢</span> 
                            <span id="res-tension">12%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center: Date -->
            <div class="absolute left-1/2 -translate-x-1/2 top-0 h-full flex flex-col justify-center items-center bg-black/40 px-6 border-x border-white/5">
                <div id="date-display" class="text-2xl header-font text-gray-200 tracking-wider">01 JAN 2000</div>
                <div class="flex gap-1 mt-1">
                    <button onclick="setSpeed(0)" class="w-6 h-4 flex items-center justify-center bg-gray-800 text-[8px] hover:bg-gray-700">||</button>
                    <button onclick="setSpeed(1)" class="w-6 h-4 flex items-center justify-center bg-gray-800 text-[8px] hover:bg-gray-700">></button>
                    <button onclick="setSpeed(3)" class="w-6 h-4 flex items-center justify-center bg-gray-800 text-[8px] hover:bg-gray-700">>></button>
                </div>
            </div>

            <!-- Right: Menu -->
            <div>
                <button class="btn-main px-4 py-2 text-xs">–ú–ï–ù–Æ</button>
            </div>
        </header>

        <!-- MAIN AREA -->
        <div class="flex-grow relative bg-[#0e1114] overflow-hidden">
            <svg id="game-map" class="w-full h-full cursor-crosshair"></svg>
            
            <!-- Map Overlay UI: Target Info -->
            <div id="target-panel" class="absolute top-4 right-4 w-80 iron-panel hidden flex-col z-40 transition-transform">
                <div class="bg-black p-2 border-b border-gray-700 flex justify-between items-center">
                    <span id="tg-name" class="header-font text-xl text-white ml-2">GERMANY</span>
                    <button onclick="closeTarget()" class="text-red-500 hover:text-white px-2">‚úï</button>
                </div>
                
                <div class="p-4 space-y-4">
                    <!-- Status -->
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gray-800 border border-gray-600 rounded-full overflow-hidden relative">
                            <div class="absolute inset-0 flex items-center justify-center text-3xl">üë§</div>
                        </div>
                        <div>
                            <div class="text-[10px] uppercase text-gray-500 font-bold">–õ–∏–¥–µ—Ä</div>
                            <div id="tg-leader" class="text-sm font-bold text-white">G. SCHROEDER</div>
                            <div id="tg-ideology" class="text-[10px] text-blue-400 mt-1">–î–ï–ú–û–ö–†–ê–¢–ò–Ø</div>
                        </div>
                    </div>

                    <!-- Relations -->
                    <div class="bg-black/30 p-2 border border-white/5">
                        <div class="flex justify-between text-[10px] mb-1">
                            <span class="text-gray-500 uppercase">–ú–ù–ï–ù–ò–ï –û –ù–ê–°</span>
                            <span id="tg-rel" class="font-bold text-green-500">+20</span>
                        </div>
                        <div class="w-full h-1 bg-gray-700">
                            <div id="tg-rel-bar" class="h-full bg-green-500 w-1/2 transition-all"></div>
                        </div>
                    </div>

                    <!-- War Justification UI -->
                    <div id="war-section" class="border-t border-white/10 pt-2">
                        <!-- State: Idle -->
                        <div id="war-idle" class="space-y-2">
                            <button onclick="startJustify()" class="w-full py-2 btn-main btn-war text-xs tracking-wider">
                                –û–ü–†–ê–í–î–ê–¢–¨ –¶–ï–õ–¨ –í–û–ô–ù–´
                            </button>
                            <div class="text-[9px] text-center text-gray-500">
                                –¢—Ä–µ–±—É–µ—Ç—Å—è: 50 PP ‚Ä¢ –í—Ä–µ–º—è: 30 –¥–Ω–µ–π
                            </div>
                        </div>

                        <!-- State: Justifying -->
                        <div id="war-progress" class="hidden space-y-2">
                            <div class="flex justify-between text-[10px] text-yellow-500 font-bold">
                                <span>–§–ê–ë–†–ò–ö–ê–¶–ò–Ø...</span>
                                <span id="justify-timer">29 –¥–Ω.</span>
                            </div>
                            <div class="progress-container">
                                <div id="justify-bar" class="progress-fill w-0"></div>
                            </div>
                            <button onclick="cancelJustify()" class="w-full py-1 btn-main text-[10px] text-gray-400">–û–¢–ú–ï–ù–ê</button>
                        </div>

                        <!-- State: Ready -->
                        <div id="war-ready" class="hidden space-y-2 animate-pulse">
                            <div class="text-center text-xs text-red-500 font-bold border border-red-900 bg-red-900/20 p-1">
                                CASUS BELLI –ì–û–¢–û–í
                            </div>
                            <button onclick="declareWar()" class="w-full py-3 btn-main btn-war text-sm font-bold border-2 border-red-500 text-red-100 hover:text-white">
                                –û–ë–™–Ø–í–ò–¢–¨ –í–û–ô–ù–£
                            </button>
                        </div>

                         <!-- State: At War -->
                         <div id="war-active" class="hidden space-y-2">
                            <div class="bg-red-900/30 border border-red-600 p-2 text-center">
                                <div class="text-xs font-black text-red-500 tracking-widest mb-1">–í–û–ô–ù–ê</div>
                                <div class="text-[10px] text-gray-300">–ü–†–û–ì–†–ï–°–° –ó–ê–•–í–ê–¢–ê</div>
                                <div class="progress-container mt-1 h-4 border-red-800 bg-black">
                                    <div id="conquest-bar" class="progress-fill war-fill" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-[9px] mt-1 font-mono">
                                    <span id="war-score">0%</span>
                                    <span>–ö–ê–ü–ò–¢–£–õ–Ø–¶–ò–Ø</span>
                                </div>
                            </div>
                         </div>
                    </div>

                    <!-- Normal Diplo -->
                    <div class="grid grid-cols-2 gap-2">
                        <button class="py-2 btn-main btn-diplo text-[10px]">–£–ª—É—á—à–∏—Ç—å –æ—Ç–Ω.</button>
                        <button class="py-2 btn-main text-[10px]">–¢–æ—Ä–≥–æ–≤–ª—è</button>
                    </div>
                </div>
            </div>
            
            <!-- EVENT POPUP -->
            <div id="event-modal" class="modal-overlay hidden">
                <div class="modal-content" style="width: 500px; border-color: #8a3636;">
                    <div class="modal-header bg-red-900/20 text-red-500 border-red-800">
                        –°–†–û–ß–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï
                    </div>
                    <div class="p-6 bg-black flex gap-6">
                        <div class="w-1/3">
                            <div class="w-full h-32 bg-gray-800 border border-gray-600 flex items-center justify-center text-4xl">
                                ‚ö†
                            </div>
                        </div>
                        <div class="w-2/3">
                            <h3 id="ev-title" class="text-xl font-bold text-white mb-2 typewriter">–¢–ï–†–ê–ö–¢ –í –°–¢–û–õ–ò–¶–ï</h3>
                            <p id="ev-desc" class="text-xs text-gray-400 leading-relaxed mb-4 typewriter">
                                –ì—Ä—É–ø–ø–∞ —ç–∫—Å—Ç—Ä–µ–º–∏—Å—Ç–æ–≤ —Å–æ–≤–µ—Ä—à–∏–ª–∞ –∞—Ç–∞–∫—É. –ü–æ–≥–∏–±–ª–∏ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–µ. –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç.
                            </p>
                            <div id="ev-options" class="space-y-2">
                                <!-- Options injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- BOTTOM TICKER -->
        <div class="news-ticker-container">
            <div class="bg-red-900 text-white px-4 text-xs font-bold h-full flex items-center z-20 shadow-lg">–ú–ò–†–û–í–´–ï –ù–û–í–û–°–¢–ò</div>
            <div id="news-feed" class="news-content">
                +++ 2000 –ì–û–î –ù–ê–°–¢–£–ü–ò–õ +++ –ú–ò–† –í –û–ñ–ò–î–ê–ù–ò–ò –ü–ï–†–ï–ú–ï–ù +++ –≠–ö–û–ù–û–ú–ò–ö–ê –†–ê–°–¢–ï–¢ +++
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const CONFIG = {
            START_YEAR: 2000,
            END_YEAR: 2222,
            TICK_RATE_MS: 500 // Base speed
        };

        const COUNTRIES_DB = {
            'RUS': { name: '–†–æ—Å—Å–∏—è', color: '#682626', ideology: '–ê–≤—Ç–æ—Ä–∏—Ç–∞—Ä–∏–∑–º', leaders: [
                { name: 'Vladimir Putin', start: 2000, end: 2008 },
                { name: 'Dmitry Medvedev', start: 2008, end: 2012 },
                { name: 'Vladimir Putin', start: 2012, end: 2030 } // Extended for gameplay
            ]},
            'USA': { name: '–°–®–ê', color: '#263859', ideology: '–î–µ–º–æ–∫—Ä–∞—Ç–∏—è', leaders: [
                { name: 'Bill Clinton', start: 1993, end: 2001 },
                { name: 'George W. Bush', start: 2001, end: 2009 },
                { name: 'Barack Obama', start: 2009, end: 2017 },
                { name: 'Donald Trump', start: 2017, end: 2021 },
                { name: 'Joe Biden', start: 2021, end: 2025 },
                { name: 'Donald Trump', start: 2025, end: 2029 }
            ]},
            'CHN': { name: '–ö–∏—Ç–∞–π', color: '#8a6b28', ideology: '–ö–æ–º–º—É–Ω–∏–∑–º', leaders: [
                { name: 'Jiang Zemin', start: 1993, end: 2003 },
                { name: 'Hu Jintao', start: 2003, end: 2013 },
                { name: 'Xi Jinping', start: 2013, end: 2035 }
            ]},
            'DEU': { name: '–ì–µ—Ä–º–∞–Ω–∏—è', color: '#3d3d3d', ideology: '–î–µ–º–æ–∫—Ä–∞—Ç–∏—è', leaders: [
                { name: 'Gerhard Schroeder', start: 1998, end: 2005 },
                { name: 'Angela Merkel', start: 2005, end: 2021 },
                { name: 'Olaf Scholz', start: 2021, end: 2025 }
            ]},
            'UKR': { name: '–£–∫—Ä–∞–∏–Ω–∞', color: '#286b8a', ideology: '–î–µ–º–æ–∫—Ä–∞—Ç–∏—è', leaders: [
                { name: 'Leonid Kuchma', start: 1994, end: 2005 },
                { name: 'Viktor Yushchenko', start: 2005, end: 2010 },
                { name: 'Viktor Yanukovych', start: 2010, end: 2014 },
                { name: 'Petro Poroshenko', start: 2014, end: 2019 },
                { name: 'Volodymyr Zelenskyy', start: 2019, end: 2029 }
            ]}
        };

        const EVENTS_DB = [
            {
                id: 'school_attack',
                title: '–¢–†–ê–ì–ï–î–ò–Ø –í –®–ö–û–õ–ï',
                desc: '–í–æ–æ—Ä—É–∂–µ–Ω–Ω–æ–µ –Ω–∞–ø–∞–¥–µ–Ω–∏–µ –Ω–∞ —É—á–µ–±–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ. –°—Ç—Ä–∞–Ω–∞ –≤ —à–æ–∫–µ.',
                options: [
                    { text: '–û–±—ä—è–≤–∏—Ç—å —Ç—Ä–∞—É—Ä (–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å -5%)', effect: (s) => s.stab -= 5 },
                    { text: '–£—Å–∏–ª–∏—Ç—å –æ—Ö—Ä–∞–Ω—É (–ü–æ–ª–∏—Ç. –≤–ª–∞—Å—Ç—å -20)', effect: (s) => s.pp -= 20 }
                ],
                chance: 0.0005 // Very rare per tick
            },
            {
                id: 'market_crash',
                title: '–û–ë–í–ê–õ –†–´–ù–ö–û–í',
                desc: '–ö—Ä—É–ø–Ω–µ–π—à–∏–µ –±–∏—Ä–∂–∏ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç —Ä–µ–∫–æ—Ä–¥–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤.',
                options: [
                    { text: '–í–ª–∏—Ç—å —Ä–µ–∑–µ—Ä–≤—ã (–ë—é–¥–∂–µ—Ç -500)', effect: (s) => s.pp -= 50 }, // Simplified to PP
                    { text: '–ü—É—Å—Ç—å —Ä—ã–Ω–æ–∫ —Ä–µ—à–∞–µ—Ç (–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å -10%)', effect: (s) => s.stab -= 10 }
                ],
                chance: 0.0003
            },
            {
                id: 'terror_act',
                title: '–¢–ï–†–ê–ö–¢ –í –ú–ï–¢–†–û',
                desc: '–í–∑—Ä—ã–≤ –≤ —Å—Ç–æ–ª–∏—á–Ω–æ–º –º–µ—Ç—Ä–æ–ø–æ–ª–∏—Ç–µ–Ω–µ. –¢—Ä–µ–±—É–µ—Ç—Å—è –∂–µ—Å—Ç–∫–∞—è —Ä–µ–∞–∫—Ü–∏—è.',
                options: [
                    { text: '–ê–Ω—Ç–∏—Ç–µ—Ä—Ä–æ—Ä. –æ–ø–µ—Ä–∞—Ü–∏—è (–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ +2%)', effect: (s) => { s.stab += 5; document.getElementById('res-tension').innerText = (parseInt(document.getElementById('res-tension').innerText)+2) + '%'; } },
                    { text: '–°–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ (–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å -5%)', effect: (s) => s.stab -= 5 }
                ],
                chance: 0.0004
            }
        ];

        const FUTURE_NAMES_FIRST = ["Cyber", "Neo", "X-", "Ion", "Nova", "Tech", "Alpha", "Omega", "Zion"];
        const FUTURE_NAMES_LAST = ["Unit", "Core", "Prime", "7", "X", "V", "Mind", "Flux", "Synth"];

        // --- STATE ---
        let state = {
            player: null, // ID
            selectedTarget: null, // ID
            date: new Date(2000, 0, 1),
            speed: 0,
            countries: [], // Array of objects
            justifications: {}, // targetId: { progress: 0, active: bool, ready: bool }
            wars: {}, // targetId: { progress: 0, active: bool }
            resources: { pp: 250, stab: 80 }
        };

        let loopInterval = null;

        // --- INITIALIZATION ---
        window.onload = async () => {
            await initMap();
            renderSelectionList();
        };

        async function initMap() {
            const svg = d3.select("#game-map");
            const width = window.innerWidth;
            const height = window.innerHeight;

            // Fallback map logic handled via fetching
            try {
                const res = await fetch('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson');
                const data = await res.json();
                
                state.countries = data.features.map((f, i) => {
                    const id = f.id || f.properties.name.substring(0,3).toUpperCase();
                    // Merge with DB if exists
                    const dbData = COUNTRIES_DB[id] || { 
                        name: f.properties.name, 
                        color: '#333', 
                        ideology: '–ù–µ–π—Ç—Ä–∞–ª–∏—Ç–µ—Ç',
                        leaders: [] 
                    };
                    
                    return {
                        id: id,
                        geo: f,
                        ...dbData,
                        currentLeader: getLeaderForDate(dbData.leaders, 2000) || "Generic Leader",
                        army: Math.floor(Math.random() * 500) + 50,
                        gdp: (Math.random() * 2 + 0.1).toFixed(1)
                    };
                });
            } catch (e) {
                console.error("Map fetch failed", e);
                // Minimal fallback for code to not crash if fetch fails
                state.countries = [];
            }

            // Draw Map
            const projection = d3.geoNaturalEarth1().scale(width / 5.5).translate([width/2.2, height/2]);
            const path = d3.geoPath().projection(projection);

            svg.append("g")
                .selectAll("path")
                .data(state.countries)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("class", "province")
                .attr("id", d => `map-${d.id}`)
                .attr("fill", "#222") // Default fog of war style
                .on("click", (e, d) => onMapClick(d));
            
            // Zoom
            svg.call(d3.zoom().on("zoom", (e) => svg.select("g").attr("transform", e.transform)));
        }

        // --- SELECTION LOGIC ---
        function renderSelectionList() {
            const list = document.getElementById('country-list');
            // Show only major/defined countries first
            const majors = state.countries.filter(c => COUNTRIES_DB[c.id]);
            const others = state.countries.filter(c => !COUNTRIES_DB[c.id]).slice(0, 10); // Limit list

            [...majors, ...others].forEach(c => {
                const btn = document.createElement('div');
                btn.className = "p-2 bg-gray-800 border border-gray-600 hover:bg-yellow-900/50 cursor-pointer flex justify-between items-center";
                btn.innerHTML = `<span class="font-bold">${c.name}</span> <span class="text-[9px] text-gray-500">${c.id}</span>`;
                btn.onclick = () => showSelectionDetails(c);
                list.appendChild(btn);
            });
        }

        function showSelectionDetails(c) {
            document.getElementById('select-placeholder').classList.add('hidden');
            document.getElementById('select-details').classList.remove('hidden');
            
            document.getElementById('sel-name').innerText = c.name;
            document.getElementById('sel-ideology').innerText = c.ideology;
            document.getElementById('sel-leader').innerText = c.currentLeader;
            document.getElementById('sel-army').innerText = c.army + "K";
            document.getElementById('sel-gdp').innerText = "$" + c.gdp + "T";
            
            // Temporary stash for start
            state.tempSelected = c.id;
        }

        function startGame() {
            if (!state.tempSelected) return;
            state.player = state.tempSelected;
            
            document.getElementById('selection-screen').style.display = 'none';
            document.getElementById('game-ui').classList.remove('hidden');

            const playerCountry = state.countries.find(c => c.id === state.player);
            
            // Init UI
            document.getElementById('game-country').innerText = playerCountry.name;
            document.getElementById('game-leader').innerText = playerCountry.currentLeader;
            document.getElementById('stat-army').innerText = playerCountry.army + "K";
            
            // Colorize map (Player green, others gray/ideological)
            d3.selectAll('.province')
                .attr("fill", d => {
                    if (d.id === state.player) return "#2d5228"; // Player Green
                    if (COUNTRIES_DB[d.id]) return COUNTRIES_DB[d.id].color; // Historical Color
                    return "#1a1a1a"; // Generic
                });

            addNews("–ù–û–í–û–ï –¢–´–°–Ø–ß–ï–õ–ï–¢–ò–ï –ù–ê–°–¢–£–ü–ò–õ–û. –ú–ò–† –°–ú–û–¢–†–ò–¢ –ù–ê –í–ê–°.");
        }

        // --- GAME LOOP & TIME ---
        function setSpeed(s) {
            state.speed = s;
            if (loopInterval) clearInterval(loopInterval);
            
            if (s > 0) {
                const ms = s === 1 ? 1000 : (s === 2 ? 300 : 100); // 1 sec = 1 day, or faster
                loopInterval = setInterval(gameTick, ms);
            }
        }

        function gameTick() {
            // Advance Time
            state.date.setDate(state.date.getDate() + 1);
            updateDateUI();

            // Resources
            state.resources.pp += 0.5;
            document.getElementById('res-pp').innerText = Math.floor(state.resources.pp);

            // Update Leaders (Monthly check for performance)
            if (state.date.getDate() === 1) {
                updateLeaders();
            }

            // Process Justifications
            processJustifications();

            // Process Wars
            processWars();

            // Random Events
            if (Math.random() < 0.005) { // 0.5% chance per day
                triggerRandomEvent();
            }

            // End Game check
            if (state.date.getFullYear() >= CONFIG.END_YEAR) {
                setSpeed(0);
                alert("2222 –ì–û–î. –°–ò–ú–£–õ–Ø–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê.");
            }
        }

        function updateDateUI() {
            const months = ["–Ø–ù–í", "–§–ï–í", "–ú–ê–†", "–ê–ü–†", "–ú–ê–ô", "–ò–Æ–ù", "–ò–Æ–õ", "–ê–í–ì", "–°–ï–ù", "–û–ö–¢", "–ù–û–Ø", "–î–ï–ö"];
            const d = state.date;
            document.getElementById('date-display').innerText = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
        }

        function updateLeaders() {
            const year = state.date.getFullYear();
            
            state.countries.forEach(c => {
                if (COUNTRIES_DB[c.id]) {
                    // Historical Logic
                    if (year <= 2026) {
                        const newLeader = getLeaderForDate(COUNTRIES_DB[c.id].leaders, year);
                        if (newLeader && newLeader !== c.currentLeader) {
                            c.currentLeader = newLeader;
                            if (c.id === state.player) {
                                document.getElementById('game-leader').innerText = newLeader;
                                addNews(`–°–ú–ï–ù–ê –í–õ–ê–°–¢–ò: ${newLeader} –¢–ï–ü–ï–†–¨ –í–û –ì–õ–ê–í–ï –°–¢–†–ê–ù–´.`);
                            }
                        }
                    } else {
                        // AI Generation (Change every ~5 years random)
                        if (Math.random() < 0.02 && year > 2026) {
                            c.currentLeader = generateAILeader();
                        }
                    }
                }
            });
            
            // Refresh Target Panel if open
            if (state.selectedTarget) {
                const t = state.countries.find(c => c.id === state.selectedTarget);
                document.getElementById('tg-leader').innerText = t.currentLeader;
            }
        }

        function getLeaderForDate(leaders, year) {
            const entry = leaders.find(l => year >= l.start && year < l.end);
            return entry ? entry.name : null;
        }

        function generateAILeader() {
            const f = FUTURE_NAMES_FIRST[Math.floor(Math.random() * FUTURE_NAMES_FIRST.length)];
            const l = FUTURE_NAMES_LAST[Math.floor(Math.random() * FUTURE_NAMES_LAST.length)];
            const num = Math.floor(Math.random() * 99);
            return `${f}-${l} v.${num}`;
        }

        // --- MAP INTERACTION ---
        function onMapClick(d) {
            if (d.id === state.player) return; // Can't select self for diplomacy
            
            state.selectedTarget = d.id;
            const panel = document.getElementById('target-panel');
            panel.classList.remove('hidden');
            panel.style.display = 'flex';

            document.getElementById('tg-name').innerText = d.name;
            document.getElementById('tg-leader').innerText = d.currentLeader;
            document.getElementById('tg-ideology').innerText = d.ideology;
            
            // Reset UI State based on relation
            refreshWarUI(d.id);
        }

        function closeTarget() {
            document.getElementById('target-panel').classList.add('hidden');
            state.selectedTarget = null;
        }

        // --- WAR MECHANICS ---
        function refreshWarUI(targetId) {
            const idle = document.getElementById('war-idle');
            const progress = document.getElementById('war-progress');
            const ready = document.getElementById('war-ready');
            const active = document.getElementById('war-active');
            
            idle.classList.add('hidden');
            progress.classList.add('hidden');
            ready.classList.add('hidden');
            active.classList.add('hidden');

            // Check State
            if (state.wars[targetId]) {
                active.classList.remove('hidden');
                updateWarUI(targetId);
                return;
            }

            const just = state.justifications[targetId];
            if (!just) {
                idle.classList.remove('hidden');
            } else if (just.ready) {
                ready.classList.remove('hidden');
            } else {
                progress.classList.remove('hidden');
                document.getElementById('justify-bar').style.width = just.progress + '%';
            }
        }

        function startJustify() {
            if (state.resources.pp < 50) {
                alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –≤–ª–∞—Å—Ç–∏ (–ù—É–∂–Ω–æ 50)");
                return;
            }
            state.resources.pp -= 50;
            const target = state.selectedTarget;
            
            state.justifications[target] = { progress: 0, active: true, ready: false };
            refreshWarUI(target);
            addNews(`–ù–ê–ß–ê–¢–ê –ü–û–î–ì–û–¢–û–í–ö–ê –û–ü–†–ê–í–î–ê–ù–ò–Ø –í–û–ô–ù–´ –ü–†–û–¢–ò–í ${target}`);
        }

        function cancelJustify() {
            const target = state.selectedTarget;
            delete state.justifications[target];
            refreshWarUI(target);
        }

        function processJustifications() {
            for (const [tid, data] of Object.entries(state.justifications)) {
                if (data.active && !data.ready) {
                    data.progress += 2; // ~50 days to finish at 1 tick/day (simplified logic for speed 1)
                    if (data.progress >= 100) {
                        data.progress = 100;
                        data.ready = true;
                        data.active = false; // Stopped processing, waiting for declaration
                        addNews(`CASUS BELLI –ü–†–û–¢–ò–í ${tid} –ì–û–¢–û–í!`);
                        if (state.selectedTarget === tid) refreshWarUI(tid);
                    } else {
                        if (state.selectedTarget === tid) {
                            document.getElementById('justify-bar').style.width = data.progress + '%';
                            document.getElementById('justify-timer').innerText = Math.ceil((100 - data.progress)/2) + " –¥–Ω.";
                        }
                    }
                }
            }
        }

        function declareWar() {
            const target = state.selectedTarget;
            const just = state.justifications[target];
            if (!just || !just.ready) return;

            // Remove justification, start war
            delete state.justifications[target];
            state.wars[target] = { progress: 0, active: true };
            
            refreshWarUI(target);
            
            // Visuals
            const mapEl = d3.select(`#map-${target}`);
            mapEl.classed('war-active-border', true); // Flashing border
            
            addNews(`–í–û–ô–ù–ê –û–ë–™–Ø–í–õ–ï–ù–ê: ${target}! –í–û–ô–°–ö–ê –ü–ï–†–ï–°–ï–ö–õ–ò –ì–†–ê–ù–ò–¶–£.`);
        }

        function processWars() {
            for (const [tid, data] of Object.entries(state.wars)) {
                if (data.active) {
                    // War Logic: Random fluctuation upwards
                    // In a real game, this would depend on Army Strength comparison
                    const gain = Math.random() * 0.5; 
                    data.progress += gain;

                    if (data.progress >= 100) {
                        // Victory
                        data.progress = 100;
                        data.active = false;
                        countryCapitulated(tid);
                    }

                    // Update UI if viewing this country
                    if (state.selectedTarget === tid) {
                        updateWarUI(tid);
                    }
                }
            }
        }

        function updateWarUI(tid) {
            const data = state.wars[tid];
            if(data) {
                document.getElementById('conquest-bar').style.width = data.progress + '%';
                document.getElementById('war-score').innerText = Math.floor(data.progress) + '%';
            }
        }

        function countryCapitulated(tid) {
            addNews(`–ü–û–ë–ï–î–ê! ${tid} –ö–ê–ü–ò–¢–£–õ–ò–†–û–í–ê–õ–ê –ü–ï–†–ï–î –ù–ê–®–ò–ú–ò –í–û–ô–°–ö–ê–ú–ò.`);
            delete state.wars[tid];
            
            // Visual conquest
            const mapEl = d3.select(`#map-${tid}`);
            mapEl.classed('war-active-border', false);
            mapEl.classed('province', false); // Stop hover effects maybe?
            mapEl.attr('fill', '#2d5228'); // Change to player color permanently
            
            // Optional: Use occupied hatch pattern
            mapEl.style('fill', 'url(#occupied-hatch) #2d5228');

            if (state.selectedTarget === tid) {
                closeTarget(); // Close panel as country is gone/annexed
            }
        }

        // --- EVENTS ---
        function triggerRandomEvent() {
            const ev = EVENTS_DB[Math.floor(Math.random() * EVENTS_DB.length)];
            
            // Show Modal
            setSpeed(0); // Pause game
            const modal = document.getElementById('event-modal');
            modal.classList.remove('hidden');
            
            document.getElementById('ev-title').innerText = ev.title;
            document.getElementById('ev-desc').innerText = ev.desc;
            
            const optsContainer = document.getElementById('ev-options');
            optsContainer.innerHTML = '';
            
            ev.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full py-2 bg-gray-800 hover:bg-gray-700 text-xs border border-gray-600 text-left px-4";
                btn.innerText = `> ${opt.text}`;
                btn.onclick = () => {
                    opt.effect(state.resources);
                    modal.classList.add('hidden');
                    setSpeed(1); // Resume
                };
                optsContainer.appendChild(btn);
            });
        }

        // --- NEWS TICKER ---
        function addNews(text) {
            const feed = document.getElementById('news-feed');
            feed.innerText = `+++ ${text} +++ ` + feed.innerText.substring(0, 100);
        }

    </script>
</body>
</html>
