<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Hegemony: Infinite Century</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Firebase Configuration (Provided by environment)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'global-hegemony-v1';

        window.db = db;
        window.auth = auth;
        window.appId = appId;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;700;900&family=Fira+Code:wght@400;500&display=swap');

        :root {
            --neon-blue: #00e5ff;
            --neon-purple: #9d00ff;
            --danger: #ff0055;
            --success: #00ffaa;
            --bg: #03040a;
        }

        body {
            background: var(--bg);
            color: #d1d5db;
            font-family: 'Exo 2', sans-serif;
            margin: 0;
            overflow: hidden;
        }

        .terminal-font { font-family: 'Fira Code', monospace; }

        /* –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è */
        .glow-border { border: 1px solid rgba(0, 229, 255, 0.3); box-shadow: 0 0 15px rgba(0, 229, 255, 0.1); }
        .glass-panel { background: rgba(10, 12, 20, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }

        /* –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç—ã */
        .country { stroke: #1a1c2c; stroke-width: 0.5px; transition: all 0.3s; cursor: pointer; outline: none; }
        .country:hover { fill: var(--neon-blue) !important; filter: drop-shadow(0 0 8px var(--neon-blue)); }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes pulse-red { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }
        .war-blink { animation: pulse-red 1s infinite; fill: var(--danger) !important; }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e2235; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--neon-blue); }

        .btn-prime {
            background: linear-gradient(135deg, #00e5ff 0%, #00a2ff 100%);
            color: #000; font-weight: 800; text-transform: uppercase;
            letter-spacing: 1px; transition: all 0.3s; clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
        }
        .btn-prime:hover { transform: scale(1.05); filter: brightness(1.2); }

        .stat-card { background: rgba(255,255,255,0.02); border-left: 3px solid var(--neon-blue); }

        /* Loader */
        .loader-overlay {
            position: fixed; inset: 0; background: var(--bg); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loader" class="loader-overlay">
        <div class="w-24 h-24 border-4 border-t-cyan-400 border-gray-800 rounded-full animate-spin"></div>
        <div class="mt-8 text-cyan-400 font-bold tracking-[0.3em] uppercase animate-pulse">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏...</div>
    </div>

    <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ / –°–û–ó–î–ê–ù–ò–ï –°–¢–†–ê–ù–´ -->
    <div id="setup-screen" class="fixed inset-0 z-[100] bg-[#05060f] overflow-y-auto custom-scrollbar hidden">
        <div class="max-w-7xl mx-auto py-20 px-6">
            <div class="flex flex-col lg:flex-row gap-16">
                
                <!-- –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç—Ä–∞–Ω (100+) -->
                <div class="w-full lg:w-1/3 space-y-8">
                    <div class="glass-panel p-6 rounded-2xl glow-border">
                        <h2 class="text-2xl font-black italic text-cyan-400 mb-6 uppercase tracking-tighter">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –†–µ–µ—Å—Ç—Ä 2000</h2>
                        <input type="text" id="country-search" placeholder="–ü–æ–∏—Å–∫ –Ω–∞—Ü–∏–∏..." class="w-full bg-black/50 border border-white/10 p-3 rounded-lg mb-4 outline-none focus:border-cyan-500 transition-all text-sm">
                        <div id="country-list" class="h-[600px] overflow-y-auto custom-scrollbar space-y-2 pr-2">
                            <!-- JS fill -->
                        </div>
                    </div>
                </div>

                <!-- –†–µ–¥–∞–∫—Ç–æ—Ä —Å–≤–æ–µ–π —Å—Ç—Ä–∞–Ω—ã -->
                <div class="flex-grow space-y-12">
                    <div class="text-center lg:text-left">
                        <h1 class="text-6xl font-black text-white uppercase tracking-tighter mb-4 italic">Global <span class="text-cyan-400">Hegemony</span></h1>
                        <p class="text-gray-500 font-medium tracking-widest text-sm">–í–´–ë–ï–†–ò–¢–ï –ü–£–¢–¨ –ò–õ–ò –°–û–ó–î–ê–ô–¢–ï –ù–û–í–£–Æ –°–£–î–¨–ë–£</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <!-- –§–æ—Ä–º–∞ –¥–∞–Ω–Ω—ã—Ö -->
                        <div class="glass-panel p-8 rounded-3xl space-y-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">üõ†Ô∏è</div>
                            <h3 class="text-lg font-bold text-cyan-400 uppercase tracking-widest mb-4">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –°—Ç—Ä–∞–Ω—ã</label>
                                    <input type="text" id="custom-name" placeholder="–û–§–ò–¶–ò–ê–õ–¨–ù–û–ï –ù–ê–ó–í–ê–ù–ò–ï" class="w-full bg-black/60 border border-white/10 p-4 rounded-xl outline-none focus:border-cyan-500 transition-all font-bold">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">–ò–º—è –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞</label>
                                        <input type="text" id="custom-leader-name" placeholder="–ò–º—è" class="w-full bg-black/60 border border-white/10 p-4 rounded-xl outline-none focus:border-cyan-500 transition-all">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">–§–∞–º–∏–ª–∏—è –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞</label>
                                        <input type="text" id="custom-leader-surname" placeholder="–§–∞–º–∏–ª–∏—è" class="w-full bg-black/60 border border-white/10 p-4 rounded-xl outline-none focus:border-cyan-500 transition-all">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">–ò–¥–µ–æ–ª–æ–≥–∏—è</label>
                                    <select id="custom-ideology" class="w-full bg-black/60 border border-white/10 p-4 rounded-xl outline-none focus:border-cyan-500 transition-all">
                                        <option value="Democracy">–õ–∏–±–µ—Ä–∞–ª—å–Ω–∞—è –î–µ–º–æ–∫—Ä–∞—Ç–∏—è</option>
                                        <option value="Communism">–°–æ—Ü–∏–∞–ª–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞</option>
                                        <option value="Autocracy">–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ê–≤—Ç–æ–∫—Ä–∞—Ç–∏—è</option>
                                        <option value="Technocracy">–¢–µ—Ö–Ω–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏–π –û—Ä–¥–µ–Ω</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ -->
                        <div class="glass-panel p-8 rounded-3xl space-y-6">
                            <div class="grid grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">–§–æ—Ç–æ –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞</label>
                                    <div class="aspect-[3/4] bg-black border-2 border-dashed border-white/10 rounded-2xl flex flex-col items-center justify-center relative overflow-hidden group cursor-pointer">
                                        <input type="file" id="upload-president" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="previewImage(event, 'pres-img')">
                                        <img id="pres-img" class="w-full h-full object-cover hidden">
                                        <div id="pres-placeholder" class="text-center p-4">
                                            <span class="text-3xl">üë§</span>
                                            <p class="text-[8px] mt-2 font-bold text-gray-600">–ó–ê–ì–†–£–ó–ò–¢–¨</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –§–ª–∞–≥</label>
                                    <div class="aspect-video bg-black border-2 border-dashed border-white/10 rounded-2xl flex flex-col items-center justify-center relative overflow-hidden group cursor-pointer">
                                        <input type="file" id="upload-flag" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="previewImage(event, 'flag-img')">
                                        <img id="flag-img" class="w-full h-full object-cover hidden">
                                        <div id="flag-placeholder" class="text-center p-4">
                                            <span class="text-3xl">üö©</span>
                                            <p class="text-[8px] mt-2 font-bold text-gray-600">–ó–ê–ì–†–£–ó–ò–¢–¨</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button onclick="createCustomNation()" class="w-full btn-prime py-5 rounded-2xl shadow-xl shadow-cyan-500/20">
                                –û–°–ù–û–í–ê–¢–¨ –ì–û–°–£–î–ê–†–°–¢–í–û
                            </button>
                        </div>
                    </div>

                    <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã (–∏–∑ —Å–ø–∏—Å–∫–∞) -->
                    <div id="selected-preview" class="hidden glass-panel p-10 rounded-3xl animate-in fade-in slide-in-from-bottom duration-500">
                        <div class="flex flex-col md:flex-row gap-10 items-center">
                            <div class="w-48 aspect-[3/4] bg-black rounded-2xl overflow-hidden border border-cyan-500/30">
                                <img id="prev-pres-img" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-grow space-y-4 text-center md:text-left">
                                <div class="flex items-center gap-4 justify-center md:justify-start">
                                    <img id="prev-flag-img" class="w-12 h-8 object-cover rounded shadow-lg">
                                    <h2 id="prev-name" class="text-5xl font-black italic uppercase"></h2>
                                </div>
                                <p id="prev-leader" class="text-cyan-400 font-bold tracking-widest text-sm uppercase"></p>
                                <p id="prev-desc" class="text-gray-400 text-sm max-w-2xl"></p>
                                <div class="flex gap-4 pt-4 justify-center md:justify-start">
                                    <div class="px-6 py-3 bg-white/5 rounded-xl border border-white/10 text-center">
                                        <div class="text-[8px] text-gray-500 font-bold uppercase mb-1">–≠–∫–æ–Ω–æ–º–∏–∫–∞</div>
                                        <div id="prev-gdp" class="text-lg font-black text-green-400"></div>
                                    </div>
                                    <div class="px-6 py-3 bg-white/5 rounded-xl border border-white/10 text-center">
                                        <div class="text-[8px] text-gray-500 font-bold uppercase mb-1">–ê—Ä–º–∏—è</div>
                                        <div id="prev-army" class="text-lg font-black text-red-500"></div>
                                    </div>
                                </div>
                            </div>
                            <button onclick="startPresetGame()" class="btn-prime px-12 py-8 rounded-2xl h-fit">
                                –í–ó–Ø–¢–¨ –ü–û–î –ö–û–ù–¢–†–û–õ–¨
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° –ò–ì–†–´ -->
    <div id="game-ui" class="hidden h-screen flex flex-col relative z-50">
        <!-- –í–µ—Ä—Ö–Ω—è—è –∏–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å -->
        <header class="h-20 bg-black/80 backdrop-blur-md border-b border-white/10 px-8 flex items-center justify-between z-[100]">
            <div class="flex items-center gap-6">
                <div class="relative">
                    <div class="w-14 h-14 rounded-xl bg-black border border-cyan-500/50 overflow-hidden shadow-lg shadow-cyan-500/20">
                        <img id="ui-pres-avatar" class="w-full h-full object-cover">
                    </div>
                    <img id="ui-flag-mini" class="absolute -bottom-2 -right-2 w-8 h-5 object-cover rounded border border-black shadow-md">
                </div>
                <div>
                    <h2 id="ui-country-name" class="text-xl font-black italic uppercase tracking-tighter text-white"></h2>
                    <div class="flex items-center gap-3 mt-1">
                        <span id="ui-leader-name" class="text-[10px] font-bold text-cyan-400 uppercase tracking-widest"></span>
                        <div class="w-1 h-1 rounded-full bg-gray-600"></div>
                        <span id="ui-date" class="text-[10px] font-mono text-gray-400">2000-01-01</span>
                    </div>
                </div>
            </div>

            <!-- –†–µ—Å—É—Ä—Å—ã -->
            <div class="flex items-center gap-10">
                <div class="text-center px-6 border-r border-white/5">
                    <div class="text-[8px] text-gray-500 font-bold uppercase mb-1">–ë—é–¥–∂–µ—Ç</div>
                    <div id="ui-budget" class="text-lg font-black text-green-400">$0.00T</div>
                    <div id="ui-income" class="text-[8px] text-green-600 font-bold">+0.2%</div>
                </div>
                <div class="text-center px-6 border-r border-white/5">
                    <div class="text-[8px] text-gray-500 font-bold uppercase mb-1">–ú–∏–ª–∏—Ç–∞—Ä–∏–∑–º</div>
                    <div id="ui-army" class="text-lg font-black text-red-500">0.0M</div>
                </div>
                <div class="text-center px-6">
                    <div class="text-[8px] text-gray-500 font-bold uppercase mb-1">–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å</div>
                    <div class="w-32 h-2 bg-gray-800 rounded-full mt-2 relative overflow-hidden">
                        <div id="ui-stability-bar" class="absolute inset-y-0 left-0 bg-cyan-400 transition-all duration-500" style="width: 75%"></div>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex bg-white/5 p-1 rounded-xl border border-white/10">
                    <button onclick="setSpeed(0)" class="speed-btn w-10 h-10 flex items-center justify-center hover:bg-white/10 transition rounded-lg">‚è∏</button>
                    <button onclick="setSpeed(1)" class="speed-btn w-10 h-10 flex items-center justify-center bg-cyan-500 text-black font-bold transition rounded-lg">1x</button>
                    <button onclick="setSpeed(5)" class="speed-btn w-10 h-10 flex items-center justify-center hover:bg-white/10 transition rounded-lg">3x</button>
                </div>
            </div>
        </header>

        <main class="flex-grow flex relative">
            <!-- –°–∞–π–¥–±–∞—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <aside class="w-20 hover:w-64 transition-all duration-300 bg-black/40 border-r border-white/10 flex flex-col items-center py-6 gap-8 z-[90] overflow-hidden group">
                <button onclick="showTab('policy')" class="w-12 h-12 flex items-center justify-center hover:bg-cyan-500/20 rounded-xl transition-all relative">
                    <span class="text-xl">üìú</span>
                    <span class="hidden group-hover:block absolute left-16 whitespace-nowrap text-xs font-bold uppercase">–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø–æ–ª–∏—Ç–∏–∫–∞</span>
                </button>
                <button onclick="showTab('war')" class="w-12 h-12 flex items-center justify-center hover:bg-red-500/20 rounded-xl transition-all relative">
                    <span class="text-xl">‚öîÔ∏è</span>
                    <span class="hidden group-hover:block absolute left-16 whitespace-nowrap text-xs font-bold uppercase">–ì–µ–Ω—à—Ç–∞–±</span>
                </button>
                <button onclick="showTab('tech')" class="w-12 h-12 flex items-center justify-center hover:bg-purple-500/20 rounded-xl transition-all relative">
                    <span class="text-xl">üß¨</span>
                    <span class="hidden group-hover:block absolute left-16 whitespace-nowrap text-xs font-bold uppercase">–ù–ò–û–ö–†</span>
                </button>
                <button onclick="showTab('stats')" class="w-12 h-12 flex items-center justify-center hover:bg-yellow-500/20 rounded-xl transition-all relative mt-auto">
                    <span class="text-xl">üìä</span>
                    <span class="hidden group-hover:block absolute left-16 whitespace-nowrap text-xs font-bold uppercase">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –°—Ç–∞—Ç</span>
                </button>
            </aside>

            <!-- –ö–∞—Ä—Ç–∞ –º–∏—Ä–∞ -->
            <div id="map-container" class="flex-grow bg-[#05060b] relative">
                <div id="world-map" class="w-full h-full"></div>

                <!-- –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä —Å—Ç—Ä–∞–Ω—ã -->
                <div id="inspector" class="absolute right-8 top-8 w-80 glass-panel p-6 rounded-3xl glow-border hidden animate-in slide-in-from-right duration-500">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center gap-3">
                            <img id="ins-flag" class="w-10 h-6 object-cover rounded">
                            <h3 id="ins-name" class="text-xl font-black uppercase italic tracking-tighter"></h3>
                        </div>
                        <button onclick="closeInspector()" class="text-gray-500 hover:text-white">‚úï</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="relative aspect-video rounded-2xl overflow-hidden border border-white/10 bg-black">
                            <img id="ins-pres" class="w-full h-full object-cover grayscale opacity-60">
                            <div class="absolute bottom-0 inset-x-0 p-4 bg-gradient-to-t from-black to-transparent">
                                <p id="ins-leader" class="text-[10px] font-bold text-cyan-400 uppercase tracking-widest"></p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-white/5 rounded-xl border border-white/10">
                                <p class="text-[7px] text-gray-500 uppercase font-bold mb-1">–í–í–ü</p>
                                <p id="ins-gdp" class="text-sm font-bold text-green-400"></p>
                            </div>
                            <div class="p-3 bg-white/5 rounded-xl border border-white/10">
                                <p class="text-[7px] text-gray-500 uppercase font-bold mb-1">–ê—Ä–º–∏—è</p>
                                <p id="ins-army" class="text-sm font-bold text-red-500"></p>
                            </div>
                        </div>

                        <div class="pt-4 flex flex-col gap-2">
                            <button class="w-full py-3 bg-cyan-500/10 hover:bg-cyan-500/20 border border-cyan-500/30 text-cyan-400 text-[10px] font-black uppercase rounded-xl transition">–î–∏–ø–ª–æ–º–∞—Ç–∏—è</button>
                            <button id="war-btn" class="w-full py-3 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-500 text-[10px] font-black uppercase rounded-xl transition">–û–±—ä—è–≤–∏—Ç—å –≤–æ–π–Ω—É</button>
                        </div>
                    </div>
                </div>

                <!-- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ª–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π -->
                <div id="news-overlay" class="absolute left-8 bottom-8 w-96 max-h-64 overflow-y-auto custom-scrollbar flex flex-col gap-2 pointer-events-none">
                    <!-- News items injected here -->
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === GLOBAL CONSTANTS & DATA ===
        const COUNTRIES_LIST_URL = "https://restcountries.com/v3.1/all";
        const FLAGS_BASE = "https://flagcdn.com/w160/";
        const WIKI_IMG = "https://en.wikipedia.org/api/rest_v1/page/summary/";

        let G_STATE = {
            user: null,
            world: {}, // Store all countries data
            player: null, // Current country ID
            time: new Date(2000, 0, 1),
            speed: 1,
            isLoaded: false
        };

        const PRESET_LEADERS = {
            "USA": { leader: "George W. Bush", img: "https://upload.wikimedia.org/wikipedia/commons/d/d4/George-W-Bush.jpg" },
            "RUS": { leader: "Vladimir Putin", img: "https://upload.wikimedia.org/wikipedia/commons/c/c2/Vladimir_Putin_2024.jpg" },
            "CHN": { leader: "Jiang Zemin", img: "https://upload.wikimedia.org/wikipedia/commons/6/65/Jiang_Zemin_2002.jpg" },
            "GBR": { leader: "Tony Blair", img: "https://upload.wikimedia.org/wikipedia/commons/c/c5/Tony_Blair_%282002%29.jpg" },
            "FRA": { leader: "Jacques Chirac", img: "https://upload.wikimedia.org/wikipedia/commons/7/73/Jacques_Chirac_2003.jpg" },
            "DEU": { leader: "Gerhard Schr√∂der", img: "https://upload.wikimedia.org/wikipedia/commons/4/4b/Gerhard_Schroeder_2005.jpg" }
        };

        // === INITIALIZATION ===
        async function initGame() {
            try {
                // Auth (Rule 3)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        G_STATE.user = user;
                        await loadInitialData();
                    }
                });
            } catch (err) {
                console.error("Auth error:", err);
            }
        }

        async function loadInitialData() {
            // Fetch World Map & Countries
            const [geoRes, countRes] = await Promise.all([
                fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"),
                fetch(COUNTRIES_LIST_URL)
            ]);
            
            const geoData = await geoRes.json();
            const countryData = await countRes.json();
            
            // Map countries by name
            countryData.forEach(c => {
                const code = c.cca3;
                G_STATE.world[code] = {
                    name: c.translations?.rus?.common || c.name.common,
                    code: code,
                    flag: c.flags.svg,
                    gdp: Math.floor(Math.random() * 500) + 50,
                    army: Math.floor(Math.random() * 200) + 10,
                    stability: 70 + Math.random() * 20,
                    leader: PRESET_LEADERS[code]?.leader || "–ì–ª–∞–≤–∞ –ù–∞—Ü–∏–∏",
                    presImg: PRESET_LEADERS[code]?.img || `https://ui-avatars.com/api/?name=${code}&background=random`
                };
            });

            // Try to load save (Rule 1)
            const saveRef = doc(window.db, 'artifacts', window.appId, 'users', G_STATE.user.uid, 'savegame');
            const snap = await getDoc(saveRef);
            
            if (snap.exists()) {
                const data = snap.data();
                G_STATE.player = data.player;
                G_STATE.world = data.world;
                G_STATE.time = new Date(data.time);
                startGameSession();
            } else {
                showSetupScreen();
            }
            
            document.getElementById('loader').style.display = 'none';
            initMap(geoData);
        }

        function showSetupScreen() {
            document.getElementById('setup-screen').classList.remove('hidden');
            const list = document.getElementById('country-list');
            
            Object.values(G_STATE.world).sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
                const row = document.createElement('div');
                row.className = "flex items-center gap-3 p-3 bg-white/5 rounded-xl hover:bg-cyan-500/20 cursor-pointer border border-transparent transition";
                row.innerHTML = `
                    <img src="${c.flag}" class="w-8 h-5 object-cover rounded shadow">
                    <div class="flex-grow">
                        <p class="text-xs font-bold uppercase">${c.name}</p>
                        <p class="text-[8px] text-gray-500 font-bold">${c.code}</p>
                    </div>
                `;
                row.onclick = () => previewPreset(c.code);
                list.appendChild(row);
            });
        }

        // === PLAYER ACTIONS ===
        window.previewPreset = (code) => {
            const c = G_STATE.world[code];
            document.getElementById('selected-preview').classList.remove('hidden');
            document.getElementById('prev-name').innerText = c.name;
            document.getElementById('prev-leader').innerText = c.leader;
            document.getElementById('prev-flag-img').src = c.flag;
            document.getElementById('prev-pres-img').src = c.presImg;
            document.getElementById('prev-gdp').innerText = `$${c.gdp}B`;
            document.getElementById('prev-army').innerText = `${c.army}K`;
            G_STATE.pendingPlayer = code;
        };

        window.previewImage = (event, targetId) => {
            const reader = new FileReader();
            reader.onload = () => {
                const el = document.getElementById(targetId);
                el.src = reader.result;
                el.classList.remove('hidden');
                document.getElementById(targetId.replace('img', 'placeholder')).classList.add('hidden');
            };
            reader.readAsDataURL(event.target.files[0]);
        };

        window.createCustomNation = async () => {
            const name = document.getElementById('custom-name').value;
            const lName = document.getElementById('custom-leader-name').value;
            const lSname = document.getElementById('custom-leader-surname').value;
            const ideo = document.getElementById('custom-ideology').value;
            const flag = document.getElementById('flag-img').src;
            const pres = document.getElementById('pres-img').src;

            if(!name || !lName) return;

            const code = "USR";
            G_STATE.world[code] = {
                name: name.toUpperCase(),
                code: code,
                flag: flag || `https://ui-avatars.com/api/?name=${name}&size=256`,
                gdp: 200,
                army: 50,
                stability: 85,
                leader: `${lName} ${lSname}`,
                presImg: pres || `https://ui-avatars.com/api/?name=${lName}&size=256`,
                ideology: ideo
            };
            G_STATE.player = code;
            await saveAndStart();
        };

        window.startPresetGame = async () => {
            G_STATE.player = G_STATE.pendingPlayer;
            await saveAndStart();
        };

        async function saveAndStart() {
            const saveRef = doc(window.db, 'artifacts', window.appId, 'users', G_STATE.user.uid, 'savegame');
            await setDoc(saveRef, {
                player: G_STATE.player,
                world: G_STATE.world,
                time: G_STATE.time.toISOString()
            });
            startGameSession();
        }

        function startGameSession() {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            
            const p = G_STATE.world[G_STATE.player];
            document.getElementById('ui-pres-avatar').src = p.presImg;
            document.getElementById('ui-flag-mini').src = p.flag;
            document.getElementById('ui-country-name').innerText = p.name;
            document.getElementById('ui-leader-name').innerText = p.leader;
            
            G_STATE.isLoaded = true;
            gameLoop();
            
            addNews("–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞. –ú—ã –≤ 2000 –≥–æ–¥—É.");
        }

        // === GAME LOOP ===
        function gameLoop() {
            if (!G_STATE.isLoaded || G_STATE.speed === 0) return;

            // Update Time
            G_STATE.time.setDate(G_STATE.time.getDate() + G_STATE.speed);
            document.getElementById('ui-date').innerText = G_STATE.time.toISOString().split('T')[0];

            // Monthly Tick
            if (G_STATE.time.getDate() === 1) {
                processMonthlyEconomy();
                if(Math.random() < 0.1) autoSave();
            }

            requestAnimationFrame(gameLoop);
        }

        async function autoSave() {
            if (!G_STATE.user) return;
            const saveRef = doc(window.db, 'artifacts', window.appId, 'users', G_STATE.user.uid, 'savegame');
            await setDoc(saveRef, {
                player: G_STATE.player,
                world: G_STATE.world,
                time: G_STATE.time.toISOString()
            });
        }

        function processMonthlyEconomy() {
            const p = G_STATE.world[G_STATE.player];
            // Simple growth
            p.gdp *= 1.002;
            p.stability = Math.min(100, p.stability + 0.1);
            
            updateResourcesUI();
        }

        function updateResourcesUI() {
            const p = G_STATE.world[G_STATE.player];
            document.getElementById('ui-budget').innerText = `$${(p.gdp/100).toFixed(2)}T`;
            document.getElementById('ui-army').innerText = `${p.army.toFixed(1)}M`;
            document.getElementById('ui-stability-bar').style.width = `${p.stability}%`;
        }

        window.setSpeed = (s) => {
            G_STATE.speed = s;
            document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('bg-cyan-500', 'text-black'));
            event.target.classList.add('bg-cyan-500', 'text-black');
        };

        // === MAP ENGINE ===
        function initMap(topo) {
            const container = document.getElementById('world-map');
            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select("#world-map").append("svg")
                .attr("width", width)
                .attr("height", height)
                .style("background", "transparent");

            const g = svg.append("g");
            const projection = d3.geoMercator().scale(width / 6.5).translate([width / 2, height / 1.5]);
            const path = d3.geoPath().projection(projection);

            const countries = topojson.feature(topo, topo.objects.countries).features;

            g.selectAll("path")
                .data(countries)
                .enter().append("path")
                .attr("d", path)
                .attr("class", "country")
                .attr("fill", d => {
                    // This is simple demo mapping, real mapping needs ISO lookup table
                    return "#1a1c2c";
                })
                .on("click", (e, d) => {
                    const countryName = d.properties.name;
                    // Find in world DB
                    const country = Object.values(G_STATE.world).find(c => c.name.toLowerCase() === countryName.toLowerCase());
                    if(country) showInspector(country);
                });

            svg.call(d3.zoom().scaleExtent([1, 8]).on("zoom", (event) => {
                g.attr("transform", event.transform);
            }));
        }

        function showInspector(c) {
            const ins = document.getElementById('inspector');
            ins.classList.remove('hidden');
            document.getElementById('ins-name').innerText = c.name;
            document.getElementById('ins-flag').src = c.flag;
            document.getElementById('ins-pres').src = c.presImg;
            document.getElementById('ins-leader').innerText = c.leader;
            document.getElementById('ins-gdp').innerText = `$${c.gdp}B`;
            document.getElementById('ins-army').innerText = `${c.army}K`;
            
            document.getElementById('war-btn').onclick = () => {
                addNews(`–û–ë–™–Ø–í–õ–ï–ù–ê –í–û–ô–ù–ê –ü–†–û–¢–ò–í ${c.name}!`);
                closeInspector();
            };
        }

        window.closeInspector = () => document.getElementById('inspector').classList.add('hidden');

        function addNews(text) {
            const overlay = document.getElementById('news-overlay');
            const item = document.createElement('div');
            item.className = "p-4 glass-panel border-l-4 border-cyan-500 rounded-xl text-[10px] font-bold uppercase tracking-wider animate-in slide-in-from-left duration-300";
            item.innerHTML = `<span class="text-cyan-500">[${G_STATE.time.toISOString().split('T')[0]}]</span> ${text}`;
            overlay.prepend(item);
            setTimeout(() => item.remove(), 10000);
        }

        // Run
        initGame();

    </script>
</body>
</html>
