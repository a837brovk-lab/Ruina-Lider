<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruina Lider: Global Strategy v2.0</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #e2e8f0;
            overflow: hidden;
            user-select: none;
        }

        #map-container {
            background: #000;
            position: relative;
        }
        
        .country {
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 0.5px;
            transition: fill 0.3s ease, stroke 0.3s ease;
            cursor: pointer;
            fill: #1e293b;
        }
        
        .country.player-nation {
            fill: #059669 !important;
            stroke: #fff;
            stroke-width: 1.2px;
        }

        .country.at-war {
            stroke: #ef4444;
            stroke-width: 1.5px;
            stroke-dasharray: 4;
            animation: pulse-war 2s infinite;
        }

        @keyframes pulse-war {
            0% { stroke-opacity: 0.5; }
            50% { stroke-opacity: 1; }
            100% { stroke-opacity: 0.5; }
        }

        .country.selected {
            stroke: #fbbf24;
            stroke-width: 2.5px;
        }

        .country:hover {
            fill: #334155;
            stroke: rgba(255, 255, 255, 0.5);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .terminal-text {
            font-family: 'JetBrains Mono', monospace;
        }

        .speed-btn.active {
            background-color: #10b981;
            color: white;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
        }

        .portrait-frame {
            width: 100%;
            height: 160px;
            background: linear-gradient(180deg, #1e293b, #0f172a);
            border-bottom: 2px solid rgba(255,255,255,0.05);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card {
            background: rgba(255,255,255,0.03);
            border-radius: 4px;
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .resource-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 99px;
            font-size: 11px;
            font-weight: 800;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="h-screen w-screen relative">

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="absolute inset-0 z-50 flex flex-col bg-slate-950 items-center justify-center p-10">
        <div class="max-w-6xl w-full space-y-8 animate-fade-in">
            <div class="text-center">
                <h1 class="text-7xl font-black tracking-tighter text-white italic">RUINA <span class="text-emerald-500">LIDER</span> <span class="text-xs align-top opacity-50">2.0</span></h1>
                <p class="text-slate-500 text-[10px] tracking-[0.6em] uppercase mt-2">–ì–ª–æ–±–∞–ª—å–Ω–æ–µ –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div class="md:col-span-3 bg-black/40 border border-white/10 rounded-2xl overflow-hidden relative h-[550px] shadow-2xl">
                    <svg id="selection-map" class="w-full h-full"></svg>
                    <div class="absolute top-4 left-4 flex gap-2">
                        <div class="px-3 py-1 bg-black/60 rounded text-[9px] font-bold border border-white/10">–ö–û–õ–ï–°–ò–ö–û –ú–´–®–ò –î–õ–Ø –ó–£–ú–ê</div>
                        <div class="px-3 py-1 bg-black/60 rounded text-[9px] font-bold border border-white/10">–õ–ö–ú –î–õ–Ø –í–´–ë–û–†–ê</div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl flex flex-col justify-between border-emerald-500/20">
                    <div id="preview-content" class="space-y-6">
                        <div>
                            <div class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-1">–§—Ä–∞–∫—Ü–∏—è</div>
                            <h2 id="preview-name" class="text-4xl font-black italic tracking-tighter text-emerald-500">---</h2>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="stat-card">
                                <span class="text-[9px] text-slate-500 block uppercase mb-1">–ò–¥–µ–æ–ª–æ–≥–∏—è</span>
                                <span id="preview-ideology" class="text-sm font-bold text-white tracking-wide">---</span>
                            </div>
                            <div class="stat-card">
                                <span class="text-[9px] text-slate-500 block uppercase mb-1">–í–µ—Ä—Ö–æ–≤–Ω—ã–π –õ–∏–¥–µ—Ä</span>
                                <span id="preview-leader" class="text-sm font-bold text-blue-400">---</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="stat-card text-center">
                                    <span class="text-[9px] text-slate-500 block uppercase">–ê—Ä–º–∏—è</span>
                                    <span id="preview-power" class="font-black text-lg">0</span>
                                </div>
                                <div class="stat-card text-center">
                                    <span class="text-[9px] text-slate-500 block uppercase">–≠–∫–æ–Ω–æ–º–∏–∫–∞</span>
                                    <span id="preview-econ" class="font-black text-lg">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-6 space-y-3">
                        <button id="start-btn" onclick="initializeGame()" disabled class="w-full py-5 bg-slate-800 text-slate-500 font-black rounded-xl opacity-50 cursor-not-allowed transition-all uppercase tracking-widest text-xs">
                            –ü–†–ò–ù–Ø–¢–¨ –ö–û–ú–ê–ù–î–û–í–ê–ù–ò–ï
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GAME UI -->
    <div id="game-ui" class="hidden h-full flex flex-col">
        <!-- TOP BAR -->
        <header class="h-14 bg-slate-900/95 border-b border-white/10 flex items-center justify-between px-6 z-20 backdrop-blur-xl">
            <div class="flex items-center gap-8">
                <span class="font-black text-xl italic tracking-tighter">RUINA <span class="text-emerald-500">LIDER</span></span>
                
                <div class="flex items-center gap-4 border-l border-white/10 pl-6 h-8">
                    <div class="resource-chip text-yellow-500">
                        <span>üí∞</span> <span id="res-gold">0</span>
                    </div>
                    <div class="resource-chip text-blue-400">
                        <span>üõ¢Ô∏è</span> <span id="res-oil">0</span>
                    </div>
                    <div class="resource-chip text-slate-300">
                        <span>‚öôÔ∏è</span> <span id="res-steel">0</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-10">
                <div class="flex flex-col items-center">
                    <span id="date-display" class="text-sm font-bold terminal-text">01 JAN 1936</span>
                    <span id="speed-label" class="text-[8px] text-slate-400 font-bold uppercase tracking-[0.2em]">PAUSED</span>
                </div>
                
                <div class="flex bg-black/40 rounded-lg border border-white/10 p-0.5">
                    <button id="sp-0" onclick="changeSpeed(0)" class="speed-btn px-3 py-1 rounded text-[10px] font-bold active">STOP</button>
                    <button id="sp-1" onclick="changeSpeed(1)" class="speed-btn px-3 py-1 rounded text-[10px] font-bold transition">X1</button>
                    <button id="sp-2" onclick="changeSpeed(2)" class="speed-btn px-3 py-1 rounded text-[10px] font-bold transition">X2</button>
                    <button id="sp-3" onclick="changeSpeed(3)" class="speed-btn px-3 py-1 rounded text-[10px] font-bold transition">X5</button>
                </div>
            </div>
        </header>

        <main class="flex-grow flex relative overflow-hidden">
            <div id="map-container" class="w-full h-full relative overflow-hidden bg-slate-950">
                <svg id="world-map" class="w-full h-full absolute inset-0"></svg>
                
                <!-- SIDE INFO PANEL -->
                <div id="country-info" class="absolute bottom-6 left-6 glass-panel p-0 rounded-2xl w-80 overflow-hidden transition-all duration-500 translate-y-20 opacity-0 pointer-events-none shadow-2xl border-emerald-500/10">
                    <div class="portrait-frame">
                        <!-- Procedural Leader Visual -->
                        <div id="leader-visual" class="relative w-24 h-24 rounded-full border-4 border-white/10 bg-slate-800 flex items-center justify-center overflow-hidden">
                            <div class="w-12 h-12 bg-white/20 rounded-full mb-[-10px]"></div>
                            <div class="w-20 h-10 bg-white/10 rounded-full absolute bottom-[-5px]"></div>
                        </div>
                        <div class="absolute bottom-3 left-4 right-4 text-center">
                            <div id="info-ideology" class="text-[8px] font-black bg-white/10 text-white px-2 py-0.5 rounded-full inline-block mb-1 uppercase tracking-tighter">DEMOCRACY</div>
                            <h2 id="info-leader" class="text-lg font-black leading-tight uppercase tracking-tighter truncate text-blue-400">---</h2>
                        </div>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <div class="flex justify-between items-end border-b border-white/5 pb-2">
                            <h3 id="info-name" class="text-lg font-black text-white italic truncate">Country Name</h3>
                            <span id="info-tag" class="text-[10px] font-bold text-slate-500">TAG</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="stat-card">
                                <span class="text-[9px] text-slate-500 block uppercase">–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å</span>
                                <span id="info-stability" class="text-sm font-bold text-emerald-400">95%</span>
                            </div>
                            <div class="stat-card">
                                <span class="text-[9px] text-slate-500 block uppercase">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
                                <span id="info-war-support" class="text-sm font-bold text-orange-400">40%</span>
                            </div>
                        </div>

                        <div class="space-y-2 text-[11px]">
                            <div class="flex justify-between items-center bg-white/5 p-2 rounded">
                                <span class="text-slate-400">–û–¢–ù–û–®–ï–ù–ò–Ø –° –ù–ê–ú–ò</span>
                                <div class="flex items-center gap-2">
                                    <div class="w-20 h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                        <div id="rel-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 50%"></div>
                                    </div>
                                    <span id="info-relations" class="font-bold text-white">0</span>
                                </div>
                            </div>
                            <div class="flex justify-between p-1">
                                <span class="text-slate-500">–í–û–ï–ù–ù–ê–Ø –ú–û–©–¨</span>
                                <span id="info-power" class="font-bold text-white">0</span>
                            </div>
                        </div>

                        <div id="action-panel" class="flex flex-col gap-2 pt-2">
                            <button onclick="handleDiplomacy('war')" class="py-2 bg-red-600/20 hover:bg-red-600/40 text-red-500 border border-red-500/20 rounded font-bold text-[10px] uppercase tracking-widest transition">–û–±—ä—è–≤–∏—Ç—å –≤–æ–π–Ω—É</button>
                            <button onclick="handleDiplomacy('trade')" class="py-2 bg-blue-600/20 hover:bg-blue-600/40 text-blue-500 border border-blue-500/20 rounded font-bold text-[10px] uppercase tracking-widest transition">–£–ª—É—á—à–∏—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è</button>
                        </div>
                    </div>
                </div>

                <!-- WAR STATUS INDICATOR -->
                <div id="global-war-status" class="absolute top-6 left-1/2 -translate-x-1/2 hidden">
                    <div class="px-6 py-2 bg-red-600/90 text-white rounded-full border-2 border-white/20 shadow-2xl animate-bounce flex items-center gap-3">
                        <span class="font-black italic text-sm">–í –°–û–°–¢–û–Ø–ù–ò–ò –í–û–ô–ù–´</span>
                        <div class="w-2 h-2 bg-white rounded-full animate-ping"></div>
                    </div>
                </div>
            </div>

            <!-- RIGHT TERMINAL -->
            <div class="w-80 bg-slate-950/98 border-l border-white/10 flex flex-col z-10 shadow-[-10px_0_30px_rgba(0,0,0,0.5)]">
                <div class="p-4 border-b border-white/10 flex justify-between items-center bg-slate-900/50">
                    <span class="text-[10px] font-black tracking-widest text-slate-400 uppercase">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–≥</span>
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                </div>
                <div id="chat-log" class="flex-grow overflow-y-auto p-4 space-y-3 terminal-text text-[11px] leading-relaxed scroll-smooth"></div>
                
                <div class="p-4 bg-slate-900/80 border-t border-white/10">
                    <form id="ai-form" class="relative">
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-emerald-500 font-bold">></div>
                        <input type="text" id="ai-input" autocomplete="off"
                            class="w-full bg-black/50 border border-white/10 rounded-lg py-2.5 pl-8 pr-4 text-white terminal-text text-[11px] focus:border-emerald-500/50 outline-none transition shadow-inner"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–∏—Ä–µ–∫—Ç–∏–≤—É...">
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const firstNames = ["–ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "–î–º–∏—Ç—Ä–∏–π", "–ò–≤–∞–Ω", "–°–µ—Ä–≥–µ–π", "–ú–∏—Ö–∞–∏–ª", "–í–∏–∫—Ç–æ—Ä", "–ù–∏–∫–æ–ª–∞–π", "Karl", "Joseph", "Winston", "Franklin", "Adolf", "Hirohito", "Benito"];
        const lastNames = ["–í–æ–ª–∫–æ–≤", "–®–º–∏–¥—Ç", "–°–º–∏—Ç", "–õ–∏", "–ú–æ—Ä–æ–∑–æ–≤", "–ö–∏–º", "–ë–µ—Ä–µ–∑–æ–≤", "–î—é–ø–æ–Ω", "–ú—é–ª–ª–µ—Ä", "–†–æ–¥—Ä–∏–≥–µ—Å", "–ß–µ—Ä—á–∏–ª–ª—å", "–°—Ç–∞–ª–∏–Ω", "–†—É–∑–≤–µ–ª—å—Ç"];
        const ideologies = ["–î–µ–º–æ–∫—Ä–∞—Ç–∏—è", "–ê–≤—Ç–æ—Ä–∏—Ç–∞—Ä–∏–∑–º", "–ö–æ–º–º—É–Ω–∏–∑–º", "–§–∞—à–∏–∑–º"];
        const colors = {
            "–î–µ–º–æ–∫—Ä–∞—Ç–∏—è": "#3b82f6",
            "–ê–≤—Ç–æ—Ä–∏—Ç–∞—Ä–∏–∑–º": "#6b7280",
            "–ö–æ–º–º—É–Ω–∏–∑–º": "#ef4444",
            "–§–∞—à–∏–∑–º": "#1e1b4b"
        };

        let currentLang = 'ru';
        let speed = 0;
        let gameDate = new Date(1936, 0, 1);
        let countries = [];
        let playerCountryId = null;
        let selectedCountry = null;
        let lastUpdateTime = 0;
        let playerRes = { gold: 1000, oil: 50, steel: 100 };
        let activeWars = [];

        const projection = d3.geoMercator().scale(150).translate([450, 350]);
        const path = d3.geoPath().projection(projection);

        // --- INITIALIZATION ---

        async function loadMaps() {
            try {
                const res = await fetch('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson');
                const data = await res.json();
                
                countries = data.features.map(f => {
                    const ideo = ideologies[Math.floor(Math.random() * ideologies.length)];
                    return {
                        id: f.id,
                        name: f.properties.name,
                        feature: f,
                        power: Math.floor(Math.random() * 500) + 100,
                        econ: Math.floor(Math.random() * 1000) + 200,
                        stability: 70 + Math.floor(Math.random() * 30),
                        warSupport: 10 + Math.floor(Math.random() * 50),
                        ideology: ideo,
                        relations: 0,
                        leader: `${firstNames[Math.floor(Math.random()*firstNames.length)]} ${lastNames[Math.floor(Math.random()*lastNames.length)]}`,
                        atWarWith: [],
                        capturedTerritories: [],
                        owner: f.id // Current owner of this geometry
                    };
                });

                renderSelectionMap();
            } catch (err) {
                console.error("Map load failed", err);
            }
        }

        function renderSelectionMap() {
            const svg = d3.select("#selection-map");
            const g = svg.append("g");

            g.selectAll("path")
                .data(countries)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("class", "country")
                .attr("fill", d => colors[d.ideology])
                .style("fill-opacity", 0.6)
                .on("click", function(e, d) {
                    g.selectAll(".country").classed("selected", false);
                    d3.select(this).classed("selected", true);
                    updatePreview(d);
                });

            const zoom = d3.zoom().scaleExtent([1, 10]).on("zoom", (e) => g.attr("transform", e.transform));
            svg.call(zoom);
        }

        function updatePreview(d) {
            selectedCountry = d;
            document.getElementById('preview-name').innerText = d.name;
            document.getElementById('preview-power').innerText = d.power;
            document.getElementById('preview-econ').innerText = d.econ;
            document.getElementById('preview-leader').innerText = d.leader;
            document.getElementById('preview-ideology').innerText = d.ideology;
            
            const btn = document.getElementById('start-btn');
            btn.disabled = false;
            btn.className = "w-full py-5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-500 transition-all transform hover:scale-[1.02] shadow-xl text-xs uppercase tracking-widest cursor-pointer";
        }

        function initializeGame() {
            playerCountryId = selectedCountry.id;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            
            renderMainMap();
            updateResourceUI();
            logAI(`[–°–ò–°–¢–ï–ú–ê]: –ö–æ–º–∞–Ω–¥–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –í—ã –ø—Ä–∏–Ω—è–ª–∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –Ω–∞–¥ ${selectedCountry.name}.`, "text-emerald-400 font-bold");
            logAI(`[–†–ê–ó–í–ï–î–ö–ê]: –ù—ã–Ω–µ—à–Ω–∏–π —Å—Ç—Ä–æ–π ‚Äî ${selectedCountry.ideology}. –ú–∏—Ä –Ω–∞ –≥—Ä–∞–Ω–∏ –∫—Ä–∏–∑–∏—Å–∞.`, "text-slate-400");
            
            lastUpdateTime = performance.now();
            requestAnimationFrame(loop);
        }

        // --- CORE GAME LOOP ---

        function loop(currentTime) {
            if (speed > 0) {
                const deltaTime = currentTime - lastUpdateTime;
                const speedMultipliers = [0, 1000, 500, 100]; // ms per game day
                
                if (deltaTime >= speedMultipliers[speed]) {
                    gameDate.setDate(gameDate.getDate() + 1);
                    updateDateUI();
                    processEconomy();
                    processAI();
                    lastUpdateTime = currentTime;
                }
            } else {
                lastUpdateTime = currentTime;
            }
            requestAnimationFrame(loop);
        }

        function updateDateUI() {
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            document.getElementById('date-display').innerText = gameDate.toLocaleDateString('en-GB', options).toUpperCase();
        }

        function processEconomy() {
            const player = countries.find(c => c.id === playerCountryId);
            // Every day 1% of economy / 30 for daily
            const gainGold = Math.floor(player.econ * 0.05 / 30);
            const gainOil = Math.floor(player.power * 0.01 / 30) + 1;
            const gainSteel = Math.floor(player.econ * 0.02 / 30) + 1;

            playerRes.gold += gainGold;
            playerRes.oil += gainOil;
            playerRes.steel += gainSteel;

            updateResourceUI();
        }

        function updateResourceUI() {
            document.getElementById('res-gold').innerText = Math.floor(playerRes.gold);
            document.getElementById('res-oil').innerText = Math.floor(playerRes.oil);
            document.getElementById('res-steel').innerText = Math.floor(playerRes.steel);
        }

        function processAI() {
            // Random AI diplomacy
            countries.forEach(c => {
                if (c.id === playerCountryId) return;

                // 1% chance for AI to do something daily
                if (Math.random() < 0.005) {
                    const target = countries[Math.floor(Math.random() * countries.length)];
                    if (target.id === c.id) return;

                    // AI logic: aggressive ideologies attack more
                    if ((c.ideology === '–§–∞—à–∏–∑–º' || c.ideology === '–ö–æ–º–º—É–Ω–∏–∑–º') && c.power > target.power) {
                        if (!c.atWarWith.includes(target.id)) {
                            startWar(c, target);
                        }
                    }
                }

                // If at war, simulate battles
                if (c.atWarWith.length > 0) {
                    c.atWarWith.forEach(enemyId => {
                        const enemy = countries.find(e => e.id === enemyId);
                        if (enemy && Math.random() < 0.1) simulateBattle(c, enemy);
                    });
                }
            });
        }

        function simulateBattle(c1, c2) {
            // Basic battle logic
            const strength1 = c1.power * (Math.random() + 0.5);
            const strength2 = c2.power * (Math.random() + 0.5);

            if (strength1 > strength2 * 1.5) {
                // c1 wins a minor engagement
                if (c1.id === playerCountryId || c2.id === playerCountryId) {
                    logAI(`[–§–†–û–ù–¢]: ${c1.name} –ø—Ä–æ—Ä—ã–≤–∞–µ—Ç –æ–±–æ—Ä–æ–Ω—É ${c2.name}!`, strength1 > strength2 * 2 ? "text-emerald-400" : "text-white");
                }
                c2.power -= 2;
                c1.power += 1;
            }
        }

        function startWar(c1, c2) {
            if (c1.atWarWith.includes(c2.id)) return;
            
            c1.atWarWith.push(c2.id);
            c2.atWarWith.push(c1.id);
            
            const isPlayerInvolved = c1.id === playerCountryId || c2.id === playerCountryId;
            const color = isPlayerInvolved ? "text-red-500 font-black" : "text-orange-400 font-bold";
            logAI(`[–í–û–ô–ù–ê]: ${c1.name} –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –æ–±—ä—è–≤–ª—è–µ—Ç –≤–æ–π–Ω—É ${c2.name}!`, color);
            
            if (isPlayerInvolved) {
                document.getElementById('global-war-status').classList.remove('hidden');
            }

            updateMapVisuals();
        }

        // --- MAP RENDERING & INTERACTION ---

        function renderMainMap() {
            const svg = d3.select("#world-map");
            svg.selectAll("*").remove();
            const g = svg.append("g");

            g.selectAll("path")
                .data(countries)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("class", d => `country ${d.id === playerCountryId ? 'player-nation' : ''}`)
                .attr("fill", d => colors[d.ideology])
                .attr("fill-opacity", 0.7)
                .on("mouseover", (e, d) => showInfo(d))
                .on("click", (e, d) => zoomToCountry(d))
                .on("mouseout", (e, d) => {
                    if (selectedCountry && selectedCountry.id === d.id) return;
                    // Keep info open if not strictly necessary to hide
                });

            const zoom = d3.zoom().scaleExtent([1, 20]).on("zoom", (e) => g.attr("transform", e.transform));
            svg.call(zoom);
        }

        function updateMapVisuals() {
            d3.selectAll(".country")
                .classed("at-war", d => d.atWarWith.length > 0)
                .transition()
                .duration(500)
                .attr("stroke", d => d.atWarWith.length > 0 ? "#ef4444" : "rgba(255,255,255,0.1)");
        }

        function zoomToCountry(d) {
            const svg = d3.select("#world-map");
            const bounds = path.bounds(d.feature);
            const dx = bounds[1][0] - bounds[0][0];
            const dy = bounds[1][1] - bounds[0][1];
            const x = (bounds[0][0] + bounds[1][0]) / 2;
            const y = (bounds[0][1] + bounds[1][1]) / 2;
            const scale = Math.max(1, Math.min(12, 0.9 / Math.max(dx / 900, dy / 600)));
            const translate = [450 - scale * x, 300 - scale * y];

            svg.transition().duration(1000).call(
                d3.zoom().transform, 
                d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
            );
            
            selectedCountry = d;
            showInfo(d);
        }

        function showInfo(d) {
            const panel = document.getElementById('country-info');
            panel.classList.remove('opacity-0', 'translate-y-20');
            panel.classList.add('opacity-100', 'translate-y-0', 'pointer-events-auto');
            
            document.getElementById('info-name').innerText = d.name;
            document.getElementById('info-tag').innerText = d.id;
            document.getElementById('info-power').innerText = d.power;
            document.getElementById('info-leader').innerText = d.leader;
            document.getElementById('info-ideology').innerText = d.ideology;
            document.getElementById('info-stability').innerText = `${d.stability}%`;
            document.getElementById('info-war-support').innerText = `${d.warSupport}%`;
            document.getElementById('info-relations').innerText = d.id === playerCountryId ? "---" : d.relations;
            
            const relBar = document.getElementById('rel-bar');
            const relVal = ((d.relations + 100) / 200) * 100;
            relBar.style.width = `${relVal}%`;
            
            // Action buttons
            const actionPanel = document.getElementById('action-panel');
            actionPanel.classList.toggle('hidden', d.id === playerCountryId);
        }

        function handleDiplomacy(type) {
            if (!selectedCountry) return;
            const player = countries.find(c => c.id === playerCountryId);

            if (type === 'war') {
                if (playerRes.gold < 200) {
                    logAI("[–û–®–ò–ë–ö–ê]: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –º–æ–±–∏–ª–∏–∑–∞—Ü–∏–∏.", "text-red-400");
                    return;
                }
                playerRes.gold -= 200;
                startWar(player, selectedCountry);
            } else if (type === 'trade') {
                if (playerRes.gold < 100) return;
                playerRes.gold -= 100;
                selectedCountry.relations += 15;
                if (selectedCountry.relations > 100) selectedCountry.relations = 100;
                logAI(`[–î–ò–ü–õ–û–ú–ê–¢–ò–Ø]: –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –¥–µ–ª–µ–≥–∞—Ü–∏—é –≤ ${selectedCountry.name}. –û—Ç–Ω–æ—à–µ–Ω–∏—è —É–ª—É—á—à–µ–Ω—ã.`);
            }
            showInfo(selectedCountry);
            updateResourceUI();
        }

        // --- UI HELPERS ---

        function changeSpeed(s) {
            speed = s;
            document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`sp-${s}`).classList.add('active');
            const labels = ["PAUSED", "NORMAL X1", "FAST X2", "BLITZ X5"];
            document.getElementById('speed-label').innerText = labels[s];
        }

        function logAI(msg, color = "text-slate-400") {
            const log = document.getElementById('chat-log');
            const div = document.createElement('div');
            div.className = `${color} border-l-2 border-current pl-2 py-1`;
            div.innerHTML = `<span class="opacity-30 text-[9px] block">${gameDate.toLocaleDateString()}</span>${msg}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        document.getElementById('ai-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const val = document.getElementById('ai-input').value.trim();
            if (!val) return;
            document.getElementById('ai-input').value = '';
            
            const lower = val.toLowerCase();
            logAI(`–í—ã: ${val}`, "text-white");

            // Handle basic commands
            if (lower.includes("–ø–æ–º–æ—â—å") || lower.includes("help")) {
                logAI("–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: –°–¢–ê–¢–£–°, –í–û–ô–ù–ê [–°—Ç—Ä–∞–Ω–∞], –ú–ò–†, –†–ï–°–£–†–°–´.");
            } else if (lower.includes("—Ä–µ—Å—É—Ä—Å")) {
                logAI(`–ë—é–¥–∂–µ—Ç: ${playerRes.gold} | –ù–µ—Ñ—Ç—å: ${playerRes.oil} | –°—Ç–∞–ª—å: ${playerRes.steel}`);
            } else {
                logAI("[–ò–ò]: –ö–æ–º–∞–Ω–¥–∞ –ø—Ä–∏–Ω—è—Ç–∞ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —à—Ç–∞–±–∞.");
            }
        });

        window.onload = loadMaps;
    </script>
</body>
</html>
