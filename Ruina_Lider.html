<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruina Lider: Global Strategy Ultimate</title>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --bg-dark: #020617;
            --panel-bg: rgba(15, 23, 42, 0.9);
            --accent: #10b981;
            --war: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #f1f5f9;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes pulse-red {
            0% { stroke: #ef4444; stroke-width: 1px; }
            50% { stroke: #ffffff; stroke-width: 3px; }
            100% { stroke: #ef4444; stroke-width: 1px; }
        }

        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        /* –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç—ã */
        .country {
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 0.5px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .country:hover {
            fill-opacity: 0.8;
            stroke: rgba(255, 255, 255, 0.5);
        }

        .country.selected {
            stroke: #fbbf24;
            stroke-width: 2.5px;
            filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.3));
        }

        .country.player {
            stroke: var(--accent);
            stroke-width: 2px;
        }

        .country.at-war {
            animation: pulse-red 2s infinite;
        }

        /* UI –≠–ª–µ–º–µ–Ω—Ç—ã */
        .glass {
            background: var(--panel-bg);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
        }

        .terminal-log::-webkit-scrollbar { width: 4px; }
        .terminal-log::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .portrait-placeholder {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            position: relative;
            overflow: hidden;
        }

        .portrait-placeholder::after {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(16, 185, 129, 0.1) 50%, transparent 50%);
            background-size: 100% 4px;
            pointer-events: none;
        }

        .resource-val { font-family: 'JetBrains Mono', monospace; font-weight: 700; }
        
        .btn-action {
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.7rem;
            font-weight: 800;
        }

        .btn-action:hover:not(:disabled) {
            transform: translateY(-1px);
            filter: brightness(1.2);
        }
    </style>
</head>
<body class="w-screen h-screen">

    <!-- OVERLAY: LOADING / SETUP -->
    <div id="setup-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950 overflow-hidden">
        <div class="absolute inset-0 opacity-20">
            <div class="h-full w-full" style="background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 20px 20px;"></div>
        </div>

        <div class="relative max-w-6xl w-full grid grid-cols-1 lg:grid-cols-3 gap-8 p-10 glass rounded-[2rem] shadow-2xl">
            <!-- Left Side: Map Selection -->
            <div class="lg:col-span-2 space-y-6">
                <div class="flex justify-between items-end">
                    <div>
                        <h1 class="text-6xl font-black italic tracking-tighter leading-none">RUINA <span class="text-emerald-500">LIDER</span></h1>
                        <p class="text-slate-500 font-mono text-xs mt-2 uppercase tracking-[0.3em]">Global Hegemony Protocol v2.5</p>
                    </div>
                </div>
                
                <div class="h-[500px] w-full bg-black/50 rounded-2xl border border-white/10 relative overflow-hidden">
                    <svg id="svg-setup" class="w-full h-full"></svg>
                    <div class="absolute bottom-4 left-4 flex gap-2">
                        <span class="px-2 py-1 bg-black/80 rounded text-[9px] font-bold border border-white/10">SCROLL TO ZOOM</span>
                        <span class="px-2 py-1 bg-black/80 rounded text-[9px] font-bold border border-white/10">CLICK TO SELECT</span>
                    </div>
                </div>
            </div>

            <!-- Right Side: Faction Details -->
            <div class="flex flex-col h-full">
                <div id="setup-details" class="flex-grow space-y-8">
                    <div class="space-y-2">
                        <label class="text-[10px] uppercase font-black text-emerald-500 tracking-widest">–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–≥–∏–æ–Ω</label>
                        <div id="setup-name" class="text-5xl font-black italic text-white truncate">---</div>
                    </div>

                    <div id="leader-card" class="stat-card p-0 overflow-hidden border-emerald-500/20">
                        <div class="h-32 portrait-placeholder flex items-center justify-center">
                            <svg class="w-16 h-16 text-white/10" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        </div>
                        <div class="p-4 bg-slate-900/50">
                            <div id="setup-leader" class="font-bold text-blue-400">---</div>
                            <div id="setup-ideology" class="text-[10px] text-slate-500 uppercase font-black">–ò–¥–µ–æ–ª–æ–≥–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="stat-card">
                            <span class="text-[9px] text-slate-500 uppercase block">–í–æ–µ–Ω–Ω–∞—è –º–æ—â—å</span>
                            <span id="setup-power" class="text-2xl font-black italic text-white">0</span>
                        </div>
                        <div class="stat-card">
                            <span class="text-[9px] text-slate-500 uppercase block">–í–í–ü (–º–ª—Ä–¥ $)</span>
                            <span id="setup-econ" class="text-2xl font-black italic text-white">0</span>
                        </div>
                    </div>
                </div>

                <div class="pt-8">
                    <button id="start-game-btn" disabled onclick="startGame()" class="group relative w-full py-5 bg-slate-800 rounded-xl overflow-hidden transition-all disabled:opacity-30">
                        <div class="relative z-10 text-slate-500 font-black uppercase tracking-widest text-sm group-hover:text-white transition-colors" id="btn-text">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</div>
                        <div id="btn-bg" class="absolute inset-0 bg-emerald-600 translate-y-full transition-transform duration-300 group-hover:translate-y-0"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN GAME INTERFACE -->
    <div id="game-ui" class="hidden h-full flex flex-col">
        <!-- TOP NAVIGATION BAR -->
        <header class="h-14 border-b border-white/10 glass flex items-center justify-between px-6 z-40">
            <div class="flex items-center gap-8">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-emerald-600 rounded flex items-center justify-center font-black italic text-lg shadow-[0_0_15px_rgba(16,185,129,0.4)]">R</div>
                    <span class="font-black italic text-xl tracking-tighter">RUINA <span class="text-emerald-500">LIDER</span></span>
                </div>
                
                <div class="h-6 w-px bg-white/10"></div>

                <div class="flex items-center gap-6">
                    <div class="flex flex-col">
                        <span class="text-[8px] text-slate-500 font-bold uppercase">–ë—é–¥–∂–µ—Ç</span>
                        <div class="flex items-center gap-1.5">
                            <span class="text-yellow-500 text-xs font-bold">üí∞</span>
                            <span id="res-gold" class="resource-val text-sm">1000</span>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[8px] text-slate-500 font-bold uppercase">–ù–µ—Ñ—Ç—å</span>
                        <div class="flex items-center gap-1.5">
                            <span class="text-blue-400 text-xs font-bold">üõ¢Ô∏è</span>
                            <span id="res-oil" class="resource-val text-sm">50</span>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[8px] text-slate-500 font-bold uppercase">–°—Ç–∞–ª—å</span>
                        <div class="flex items-center gap-1.5">
                            <span class="text-slate-300 text-xs font-bold">‚öôÔ∏è</span>
                            <span id="res-steel" class="resource-val text-sm">100</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-8">
                <div class="text-right">
                    <div id="game-date" class="text-sm font-black font-mono tracking-tight">01 JAN 1936</div>
                    <div id="speed-label" class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">PAUSED</div>
                </div>

                <div class="flex bg-black/40 p-1 rounded-xl border border-white/5">
                    <button onclick="setSpeed(0)" class="speed-btn w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/5 transition active-speed" id="btn-speed-0">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                    </button>
                    <button onclick="setSpeed(1)" class="speed-btn w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/5 transition" id="btn-speed-1">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <button onclick="setSpeed(2)" class="speed-btn w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/5 transition" id="btn-speed-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-grow flex relative">
            <!-- WORLD MAP -->
            <div id="map-container" class="flex-grow bg-[#010409] relative overflow-hidden">
                <svg id="svg-main" class="w-full h-full"></svg>
                
                <!-- MAP OVERLAYS -->
                <div id="war-alert" class="absolute top-6 left-1/2 -translate-x-1/2 hidden">
                    <div class="px-6 py-2 bg-red-600/90 text-white rounded-full font-black italic text-xs border border-white/20 animate-bounce">
                        –í –°–û–°–¢–û–Ø–ù–ò–ò –í–û–ô–ù–´
                    </div>
                </div>
            </div>

            <!-- SIDEBAR: INSPECTOR & LOG -->
            <aside class="w-96 border-l border-white/10 glass flex flex-col z-30 shadow-[-10px_0_30px_rgba(0,0,0,0.5)]">
                <!-- Inspector Section -->
                <div id="inspector" class="p-6 space-y-6 border-b border-white/5 hidden">
                    <div class="flex justify-between items-start">
                        <div class="space-y-1">
                            <div id="ins-tag" class="text-[9px] font-black text-slate-500 bg-white/5 px-1.5 py-0.5 rounded inline-block">TAG</div>
                            <h2 id="ins-name" class="text-3xl font-black italic text-white leading-none truncate w-48">Country</h2>
                        </div>
                        <div id="ins-ideo-badge" class="px-2 py-1 bg-emerald-500/20 text-emerald-500 text-[9px] font-black uppercase rounded border border-emerald-500/30">–î–µ–º–æ–∫—Ä–∞—Ç–∏—è</div>
                    </div>

                    <div class="flex gap-4 items-center">
                        <div class="w-16 h-16 portrait-placeholder rounded-lg flex-shrink-0"></div>
                        <div class="flex-grow">
                            <span class="text-[9px] text-slate-500 uppercase font-bold block mb-1">–õ–∏–¥–µ—Ä</span>
                            <div id="ins-leader" class="font-bold text-white text-sm">General Name</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="stat-card">
                            <span class="text-[9px] text-slate-400 block mb-1">–î–ò–í–ò–ó–ò–ò</span>
                            <div class="flex justify-between items-end">
                                <span id="ins-power" class="text-xl font-black italic">450</span>
                                <span class="text-[10px] text-red-400 mb-0.5">‚ñº 2%</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <span class="text-[9px] text-slate-400 block mb-1">–°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–¨</span>
                            <div class="flex justify-between items-end">
                                <span id="ins-stab" class="text-xl font-black italic">89%</span>
                                <span class="text-[10px] text-emerald-400 mb-0.5">‚ñ≤ 1%</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] font-bold">
                            <span class="text-slate-500 uppercase">–û—Ç–Ω–æ—à–µ–Ω–∏—è</span>
                            <span id="ins-rel-text" class="text-blue-400">0 / 100</span>
                        </div>
                        <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                            <div id="ins-rel-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 50%"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 pt-2">
                        <button onclick="handleDiplomacy('war')" class="btn-action py-3 bg-red-600/10 hover:bg-red-600/20 text-red-500 border border-red-500/30 rounded-lg">–û–±—ä—è–≤–∏—Ç—å –≤–æ–π–Ω—É</button>
                        <button onclick="handleDiplomacy('trade')" class="btn-action py-3 bg-blue-600/10 hover:bg-blue-600/20 text-blue-500 border border-blue-500/30 rounded-lg">–£–ª—É—á—à–∏—Ç—å —Å–≤—è–∑–∏</button>
                    </div>
                </div>

                <!-- Global Log Section -->
                <div class="flex-grow flex flex-col min-h-0">
                    <div class="px-6 py-4 bg-white/5 border-b border-white/5 flex justify-between items-center">
                        <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ª–æ–≥</span>
                        <div class="flex gap-1">
                            <div class="w-1 h-1 bg-emerald-500 rounded-full animate-pulse"></div>
                            <div class="w-1 h-1 bg-emerald-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                    <div id="log-content" class="flex-grow overflow-y-auto p-6 space-y-4 font-mono text-[11px] terminal-log">
                        <div class="text-emerald-500/40 italic">> –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏–∫–∞–∑–æ–≤ —à—Ç–∞–±–∞...</div>
                    </div>
                </div>
                
                <!-- Bottom Status -->
                <div class="p-4 bg-slate-900/50 border-t border-white/5 text-[9px] font-bold text-slate-500 uppercase tracking-tighter flex justify-between">
                    <span>CPU: STABLE</span>
                    <span>MEM: 94% FREE</span>
                    <span id="fps-counter">LATENCY: 12ms</span>
                </div>
            </aside>
        </main>
    </div>

    <script>
        // --- CONFIG & DATA ---
        const firstNames = ["–ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "–ù–∏–∫–æ–ª–∞–π", "Karl", "Winston", "Joseph", "Franklin", "Benito", "Charles", "Hideki", "Dmitry", "Ivan"];
        const lastNames = ["–í–æ–ª–∫–æ–≤", "Schmidt", "Smith", "Churchill", "Stalin", "Roosevelt", "Mussolini", "De Gaulle", "Tojo", "Morozov"];
        const ideos = [
            { id: 'dem', name: '–î–µ–º–æ–∫—Ä–∞—Ç–∏—è', color: '#3b82f6', icon: '‚öñÔ∏è' },
            { id: 'com', name: '–ö–æ–º–º—É–Ω–∏–∑–º', color: '#ef4444', icon: 'üö©' },
            { id: 'fas', name: '–§–∞—à–∏–∑–º', color: '#1e1b4b', icon: 'ü¶Ö' },
            { id: 'aut', name: '–ê–≤—Ç–æ—Ä–∏—Ç–∞—Ä–∏–∑–º', color: '#64748b', icon: 'üéñÔ∏è' }
        ];

        let countries = [];
        let player = null;
        let selected = null;
        let gameSpeed = 0;
        let gameDate = new Date(1936, 0, 1);
        let playerResources = { gold: 1200, oil: 60, steel: 150 };
        let activeWars = [];

        const projection = d3.geoMercator().scale(150).translate([450, 350]);
        const path = d3.geoPath().projection(projection);

        // --- CORE ENGINE ---

        async function init() {
            try {
                const res = await fetch('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson');
                const data = await res.json();
                
                countries = data.features.map(f => {
                    const ideo = ideos[Math.floor(Math.random() * ideos.length)];
                    return {
                        id: f.id,
                        name: f.properties.name,
                        feature: f,
                        ideology: ideo,
                        leader: `${firstNames[Math.floor(Math.random()*firstNames.length)]} ${lastNames[Math.floor(Math.random()*lastNames.length)]}`,
                        power: Math.floor(Math.random() * 600) + 150,
                        econ: Math.floor(Math.random() * 2000) + 500,
                        stability: 60 + Math.floor(Math.random() * 40),
                        relations: 0,
                        atWarWith: []
                    };
                });

                renderSetupMap();
            } catch (err) {
                console.error("Critical Failure:", err);
            }
        }

        function renderSetupMap() {
            const svg = d3.select("#svg-setup");
            const g = svg.append("g");

            g.selectAll("path")
                .data(countries)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("class", "country")
                .attr("fill", d => d.ideology.color)
                .attr("fill-opacity", 0.5)
                .on("click", function(e, d) {
                    d3.selectAll("#svg-setup .country").classed("selected", false);
                    d3.select(this).classed("selected", true);
                    updateSetupDetails(d);
                });

            svg.call(d3.zoom().scaleExtent([1, 8]).on("zoom", (e) => g.attr("transform", e.transform)));
        }

        function updateSetupDetails(d) {
            selected = d;
            document.getElementById('setup-name').innerText = d.name;
            document.getElementById('setup-leader').innerText = d.leader;
            document.getElementById('setup-ideology').innerText = `${d.ideology.icon} ${d.ideology.name}`;
            document.getElementById('setup-power').innerText = d.power;
            document.getElementById('setup-econ').innerText = (d.econ / 10).toFixed(1);
            
            const btn = document.getElementById('start-game-btn');
            const btnBg = document.getElementById('btn-bg');
            const btnText = document.getElementById('btn-text');
            
            btn.disabled = false;
            btnBg.classList.remove('translate-y-full');
            btnText.innerText = "–ü–†–ò–ù–Ø–¢–¨ –ö–û–ú–ê–ù–î–û–í–ê–ù–ò–ï";
            btnText.classList.add('text-white');
        }

        function startGame() {
            player = selected;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            
            renderMainMap();
            addLog(`[–°–ò–°–¢–ï–ú–ê]: –ü—Ä–æ—Ç–æ–∫–æ–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –í—ã –≤–æ–∑–≥–ª–∞–≤–∏–ª–∏ ${player.name}.`, "text-emerald-400 font-bold");
            addLog(`[–†–ê–ó–í–ï–î–ö–ê]: –ù—ã–Ω–µ—à–Ω–∏–π –ª–∏–¥–µ—Ä ‚Äî ${player.leader}. –°—Ç—Ä–æ–π ‚Äî ${player.ideology.name}.`, "text-blue-300");
            
            runGameLoop();
        }

        function renderMainMap() {
            const svg = d3.select("#svg-main");
            svg.selectAll("*").remove();
            const g = svg.append("g");

            g.selectAll("path")
                .data(countries)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("class", d => `country ${d.id === player.id ? 'player' : ''}`)
                .attr("fill", d => d.ideology.color)
                .attr("fill-opacity", 0.7)
                .on("click", (e, d) => inspectCountry(d));

            svg.call(d3.zoom().scaleExtent([1, 20]).on("zoom", (e) => g.attr("transform", e.transform)));
        }

        function inspectCountry(d) {
            selected = d;
            const ins = document.getElementById('inspector');
            ins.classList.remove('hidden');
            
            document.getElementById('ins-name').innerText = d.name;
            document.getElementById('ins-tag').innerText = d.id || "UNK";
            document.getElementById('ins-leader').innerText = d.leader;
            document.getElementById('ins-power').innerText = d.power;
            document.getElementById('ins-stab').innerText = `${d.stability}%`;
            
            const badge = document.getElementById('ins-ideo-badge');
            badge.innerText = d.ideology.name;
            badge.style.color = d.ideology.color;
            badge.style.borderColor = d.ideology.color + '44';

            const relBar = document.getElementById('ins-rel-bar');
            const relText = document.getElementById('ins-rel-text');
            const relVal = d.id === player.id ? 100 : (d.relations + 100) / 2;
            relBar.style.width = `${relVal}%`;
            relText.innerText = d.id === player.id ? "---" : `${d.relations} / 100`;
            
            // Hide buttons if inspecting ourselves
            document.querySelectorAll('.btn-action').forEach(b => b.style.display = d.id === player.id ? 'none' : 'block');
        }

        // --- GAME LOGIC ---

        function runGameLoop() {
            setInterval(() => {
                if (gameSpeed === 0) return;

                // 1. Update Date
                gameDate.setDate(gameDate.getDate() + 1);
                updateDateUI();

                // 2. Economy
                processEconomy();

                // 3. AI Behavior
                processAI();

                // 4. Update Map Visuals
                updateMapState();

            }, gameSpeed === 2 ? 100 : 800);
        }

        function processEconomy() {
            // Player gains based on econ power
            const goldGain = (player.econ / 200) * gameSpeed;
            const oilGain = (player.power / 500) * gameSpeed;
            const steelGain = (player.econ / 400) * gameSpeed;

            playerResources.gold += goldGain;
            playerResources.oil += oilGain;
            playerResources.steel += steelGain;

            updateResourceUI();
        }

        function processAI() {
            countries.forEach(c => {
                if (c.id === player.id) return;

                // AI events (1% daily chance)
                if (Math.random() < 0.005) {
                    const eventRoll = Math.random();
                    if (eventRoll > 0.95) {
                        // AI declares war on someone else
                        const target = countries[Math.floor(Math.random() * countries.length)];
                        if (target.id !== c.id && !c.atWarWith.includes(target.id)) {
                            declareWar(c, target);
                        }
                    }
                }

                // If at war, simulate attrition
                if (c.atWarWith.length > 0) {
                    c.power -= (Math.random() * 0.5);
                    if (c.power < 50) {
                        // Peace negotiation
                        const enemyId = c.atWarWith[0];
                        const enemy = countries.find(e => e.id === enemyId);
                        makePeace(c, enemy);
                    }
                }
            });
        }

        function declareWar(attacker, defender) {
            if (attacker.atWarWith.includes(defender.id)) return;
            
            attacker.atWarWith.push(defender.id);
            defender.atWarWith.push(attacker.id);
            
            const isPlayerInvolved = (attacker.id === player.id || defender.id === player.id);
            const color = isPlayerInvolved ? "text-red-500 font-black" : "text-orange-400";
            
            addLog(`[–í–û–ô–ù–ê]: ${attacker.name} –∞—Ç–∞–∫—É–µ—Ç ${defender.name}!`, color);
            
            if (isPlayerInvolved) {
                document.getElementById('war-alert').classList.remove('hidden');
                d3.selectAll(".country").filter(d => d.id === attacker.id || d.id === defender.id).classed("at-war", true);
            }
        }

        function makePeace(c1, c2) {
            c1.atWarWith = c1.atWarWith.filter(id => id !== c2.id);
            c2.atWarWith = c2.atWarWith.filter(id => id !== c1.id);
            
            addLog(`[–ú–ò–†]: ${c1.name} –∏ ${c2.name} –ø–æ–¥–ø–∏—Å–∞–ª–∏ –ø–µ—Ä–µ–º–∏—Ä–∏–µ.`, "text-blue-400");
            
            if (c1.id === player.id || c2.id === player.id) {
                document.getElementById('war-alert').classList.add('hidden');
            }
            updateMapState();
        }

        function handleDiplomacy(type) {
            if (!selected) return;

            if (type === 'war') {
                if (playerResources.gold < 300) {
                    addLog("[–û–®–ò–ë–ö–ê]: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –º–æ–±–∏–ª–∏–∑–∞—Ü–∏–∏.", "text-red-400");
                    return;
                }
                playerResources.gold -= 300;
                declareWar(player, selected);
            } else if (type === 'trade') {
                if (playerResources.gold < 150) return;
                playerResources.gold -= 150;
                selected.relations = Math.min(100, selected.relations + 25);
                addLog(`[–î–ò–ü–õ–û–ú–ê–¢–ò–Ø]: –£–ª—É—á—à–µ–Ω—ã –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å ${selected.name}.`);
            }
            inspectCountry(selected);
            updateResourceUI();
        }

        // --- UI HELPERS ---

        function updateDateUI() {
            const opt = { day: '2-digit', month: 'short', year: 'numeric' };
            document.getElementById('game-date').innerText = gameDate.toLocaleDateString('en-GB', opt).toUpperCase();
        }

        function updateResourceUI() {
            document.getElementById('res-gold').innerText = Math.floor(playerResources.gold);
            document.getElementById('res-oil').innerText = Math.floor(playerResources.oil);
            document.getElementById('res-steel').innerText = Math.floor(playerResources.steel);
        }

        function setSpeed(s) {
            gameSpeed = s;
            document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('bg-emerald-600/20', 'text-emerald-500', 'border-emerald-500/50'));
            document.getElementById(`btn-speed-${s}`).classList.add('bg-emerald-600/20', 'text-emerald-500');
            document.getElementById('speed-label').innerText = s === 0 ? "PAUSED" : s === 1 ? "NORMAL 1X" : "BLITZ 5X";
            addLog(`[–°–ò–°–¢–ï–ú–ê]: –°–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ ${s}x`);
        }

        function addLog(msg, colorClass = "text-slate-400") {
            const log = document.getElementById('log-content');
            const entry = document.createElement('div');
            entry.className = `${colorClass} py-1`;
            entry.innerHTML = `<span class="opacity-30 text-[9px] mr-2">${gameDate.toLocaleDateString()}</span> ${msg}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateMapState() {
            d3.selectAll(".country")
                .classed("at-war", d => d.atWarWith.length > 0)
                .transition()
                .duration(500)
                .attr("fill", d => d.atWarWith.length > 0 ? "#450a0a" : d.ideology.color);
        }

        window.onload = init;
    </script>
</body>
</html>
